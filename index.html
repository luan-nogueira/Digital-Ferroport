<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PresenÃ§a diÃ¡ria â€” Contratos</title>
  <link rel="stylesheet" href="style.css" />

  <!-- âœ… Firebase (COMPAT) - TEM que ficar ANTES do seu script -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<!-- ===================== LOGIN ===================== -->
<section class="login-page" id="loginBox">
  <div class="login-card">
    <div class="login-logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <h2>Acesso restrito</h2>
    <p class="muted">Entre com seu e-mail e senha para acessar o controle.</p>

    <div class="grid-2">
      <div class="field">
        <label>E-mail</label>
        <input id="loginEmail" type="email" placeholder="seuemail@empresa.com" autocomplete="username">
      </div>

      <div class="field">
        <label>Senha</label>
        <div class="input-icon">
          <input id="loginSenha" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
          <button class="icon-btn" type="button"
            onclick="toggleSenha('loginSenha', this)"
            aria-label="Mostrar/ocultar senha"
            title="Mostrar/ocultar senha">
            <span class="cam-icon cam-closed">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 7a3 3 0 0 1 3-3h6l2 2h2a3 3 0 0 1 3 3v7a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7z"></path>
                <path d="M9.5 12a2.5 2.5 0 1 0 5 0a2.5 2.5 0 0 0-5 0z"></path>
                <path d="M3 3l18 18" class="stroke"></path>
              </svg>
            </span>
            <span class="cam-icon cam-open" style="display:none;">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 7a3 3 0 0 1 3-3h6l2 2h2a3 3 0 0 1 3 3v7a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7z"></path>
                <path d="M9.5 12a2.5 2.5 0 1 0 5 0a2.5 2.5 0 0 0-5 0z"></path>
              </svg>
            </span>
          </button>
        </div>
      </div>
    </div>

    <div class="actions center">
      <button class="btn" id="btnEntrar" type="button" onclick="login()">Entrar</button>
      <button class="btn secondary" type="button" onclick="esqueciSenha()">Esqueci minha senha</button>
      <button class="btn secondary small" type="button" id="btnTemaLogin" onclick="toggleTema()">ğŸŒ™ Tema</button>
    </div>

    <div class="login-status" id="loginStatus" style="display:none;">
      <span class="spinner"></span>
      <span>Entrando...</span>
    </div>

    <p class="muted small center" id="loginMsg"></p>
    <p class="muted tiny center">DIGITAL â€¢ EMIVE â€” Tecnologia e SeguranÃ§a</p>
  </div>
</section>

<!-- ===================== APP ===================== -->
<div id="appRoot" style="display:none;">

<header class="topbar no-print">
  <div class="brand">
    <div class="logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div>
      <div class="brand-title">Controle â€” Contratos</div>
      <div class="brand-subtitle" id="userBadge">Logado como: â€”</div>
    </div>

    <div class="top-actions">
      <button class="btn secondary small" type="button" id="btnTema" onclick="toggleTema()">ğŸŒ™ Tema</button>

      <div class="field inline">
        <label>Contrato</label>
        <select id="contratoSelect" disabled>
          <option value="">Carregando...</option>
        </select>
      </div>

      <span class="role-pill" id="rolePill">â€”</span>
      <button class="btn secondary small" type="button" onclick="logout()">Sair</button>
    </div>
  </div>
</header>

<main class="container">

  <!-- ===================== PAINEL ===================== -->
  <section class="card">
    <div class="card-head">
      <h2>Painel</h2>
      <p class="muted">Selecione o mÃªs para gerar relatÃ³rio em PDF e visualizar dados do contrato.</p>
    </div>

    <div class="grid-3">
      <div class="field">
        <label>MÃªs/Ano</label>
        <input id="mesAno" type="month" />
      </div>

      <div class="field">
        <label>Resumo</label>
        <div class="kpi-wrap">
          <div class="kpi">
            <div class="kpi-label">Dias registrados</div>
            <div class="kpi-value" id="kpiDias">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">TÃ©cnicos/Condutores</div>
            <div class="kpi-value" id="kpiTecnicos">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">PresenÃ§as/Registros</div>
            <div class="kpi-value" id="kpiPresencas">0</div>
          </div>
        </div>
      </div>

      <div class="field">
        <label>AÃ§Ãµes</label>
        <div class="actions">
          <button class="btn" type="button" onclick="atualizarPainel()">ğŸ”„ Atualizar</button>
          <button class="btn secondary" type="button" onclick="gerarPDF()">ğŸ“„ Gerar PDF</button>
        </div>
        <p class="muted small">O PDF Ã© gerado via impressÃ£o do navegador (Ctrl+P).</p>
      </div>
    </div>

    <!-- Ferroport -->
    <div id="blocoFerroport">
      <div class="split">
        <div>
          <h3 class="h3">Ranking (dias trabalhados no mÃªs)</h3>
          <table class="table-compact">
            <thead>
              <tr>
                <th>#</th>
                <th>TÃ©cnico</th>
                <th>Dias</th>
                <th style="width:38%;">Progresso</th>
              </tr>
            </thead>
            <tbody id="tabelaRanking"></tbody>
          </table>
        </div>

        <div>
          <h3 class="h3">Registros do mÃªs</h3>
          <table class="table-compact">
            <thead>
              <tr>
                <th>Data</th>
                <th>Pessoas</th>
              </tr>
            </thead>
            <tbody id="tabelaMes"></tbody>
          </table>

          <div class="ver-mais-wrap">
            <button class="btn secondary small" id="btnVerMaisMes" type="button" onclick="toggleVerMaisMes()">
              Ver mais registros
            </button>
          </div>
        </div>
      </div>

      <div class="dash">
        <div class="dash-box">
          <div class="dash-title">ğŸ“Š Dias por tÃ©cnico (Top 10)</div>
          <canvas id="chartRanking" class="dash-canvas"></canvas>
          <p class="muted small">Mostra quem trabalhou mais dias no mÃªs selecionado.</p>
        </div>

        <div class="dash-box">
          <div class="dash-title">ğŸ“Œ Insights rÃ¡pidos</div>
          <div class="insights">
            <div class="insight">
              <div class="insight-label">Maior frequÃªncia</div>
              <div class="insight-value" id="insightTopNome">â€”</div>
            </div>
            <div class="insight">
              <div class="insight-label">Dias do Top 1</div>
              <div class="insight-value" id="insightTopDias">0</div>
            </div>
            <div class="insight">
              <div class="insight-label">MÃ©dia presenÃ§as/dia</div>
              <div class="insight-value" id="insightMediaDia">0</div>
            </div>
            <div class="insight">
              <div class="insight-label">MÃ©dia dias/tÃ©cnico</div>
              <div class="insight-value" id="insightMediaTec">0</div>
            </div>
          </div>
          <p class="muted small">Resumo automÃ¡tico com base no mÃªs selecionado.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Ferroport form -->
  <section class="card" id="cardPresenca">
    <div class="card-head">
      <h2>PresenÃ§a por dia (Ferroport)</h2>
      <p class="muted">Selecione a data e marque quem esteve no contrato.</p>
    </div>

    <div class="grid-2">
      <div class="field">
        <label>Data</label>
        <input id="dataDia" type="date" />
      </div>

      <div class="field">
        <label>Pessoas</label>
        <div class="chips" id="chipsDiario"></div>

        <div class="add-nome">
          <input type="text" id="novoNome" placeholder="Adicionar tÃ©cnico (ex: JoÃ£o Silva)">
          <button class="btn" type="button" onclick="adicionarNome()">+ Adicionar</button>
        </div>

        <p class="muted small">Os nomes ficam salvos no banco (tempo real).</p>
        <p class="muted small" id="permMsg" style="display:none;">VocÃª estÃ¡ como TÃ©cnico: algumas aÃ§Ãµes ficam bloqueadas.</p>
      </div>
    </div>

    <div class="actions">
      <button class="btn" type="button" onclick="salvarDiario()">ğŸ’¾ Salvar dia</button>
      <button class="btn secondary" type="button" onclick="limparDiario()">ğŸ§¹ Limpar</button>
      <button class="btn danger" id="btnApagarTudo" type="button" onclick="apagarDiarios()">ğŸ—‘ Apagar tudo</button>
      <button class="btn" type="button" onclick="exportarDiarioCSV()">â¬‡ Exportar Excel</button>
    </div>
  </section>

  <section class="card no-print" id="cardListaFerroport">
    <div class="card-head">
      <h2>PresenÃ§as registradas (Ferroport)</h2>
      <p class="muted">Se salvar a mesma data novamente, o sistema atualiza. Use â€œEditarâ€ para carregar um registro.</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Pessoas</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="tabelaDiario"></tbody>
    </table>

    <div class="ver-mais-wrap">
      <button class="btn secondary small" id="btnVerMais" type="button" onclick="toggleVerMais()">
        Ver mais registros
      </button>
    </div>
  </section>

  <footer class="footer no-print">
    DIGITAL â€¢ EMIVE â€¢ Tecnologia e SeguranÃ§a
  </footer>

</main>
</div>

<!-- ===================== PDF ===================== -->
<section class="print-only report">
  <div class="report-head">
    <div class="report-logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div class="report-titles">
      <div class="report-title">RelatÃ³rio â€” <span id="reportContrato">â€”</span></div>
      <div class="report-subtitle" id="reportPeriodo">PerÃ­odo: â€”</div>
      <div class="report-subtitle" id="reportGeradoEm">Gerado em: â€”</div>
    </div>
  </div>

  <div id="printFerroport">
    <div class="report-grid">
      <div class="report-box">
        <div class="box-title">Ranking â€” Dias trabalhados</div>
        <table class="report-table">
          <thead>
            <tr><th>#</th><th>TÃ©cnico</th><th>Dias</th></tr>
          </thead>
          <tbody id="printRanking"></tbody>
        </table>
      </div>

      <div class="report-box">
        <div class="box-title">Registros do mÃªs</div>
        <table class="report-table">
          <thead>
            <tr><th>Data</th><th>Pessoas</th></tr>
          </thead>
          <tbody id="printMes"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="report-footer">
    DIGITAL â€¢ EMIVE â€” Tecnologia e SeguranÃ§a
  </div>
</section>

<!-- ===========================================================
     âœ… SCRIPT FINAL (com FAILSAFE + seu cÃ³digo)
=========================================================== -->
<script>
(function(){
  // âœ… nunca mais tela branca sem mostrar o erro
  function showFatal(err){
    console.error(err);
    document.body.innerHTML =
      '<div style="font-family:Arial;padding:20px">' +
      '<h2 style="color:#CB3344">Erro no JavaScript</h2>' +
      '<pre style="background:#111;color:#0f0;padding:12px;border-radius:8px;white-space:pre-wrap">' +
      (err && (err.stack || err.message) ? (err.stack || err.message) : String(err)) +
      '</pre>' +
      '<p>Abra o Console (F12) para mais detalhes.</p>' +
      '</div>';
  }
  window.addEventListener("error", (e)=> showFatal(e.error || e.message));
  window.addEventListener("unhandledrejection", (e)=> showFatal(e.reason));

  document.addEventListener("DOMContentLoaded", () => {
    try{
      if(typeof firebase === "undefined"){
        throw new Error("firebase is not defined. Os scripts compat precisam estar carregados antes deste script.");
      }

      // ===================== CONFIG =====================
      const firebaseConfig = {
        apiKey: "AIzaSyBzgChouE4W25XnD-vFybJrKVN9yl3R0IQ",
        authDomain: "ferroportluannogueira.firebaseapp.com",
        projectId: "ferroportluannogueira",
        storageBucket: "ferroportluannogueira.firebasestorage.app",
        messagingSenderId: "531699539518",
        appId: "1:531699539518:web:6e32a169d9110f70b9fb6f",
        measurementId: "G-61BRVCSHD7"
      };

      const CONTRATOS = [
        { value: "ferroport",  label: "Ferroport" },
        { value: "pta-inveco", label: "PTA INVECO" }
      ];

      // âœ… evita erro de "already exists"
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

      const auth = firebase.auth();
      const db   = firebase.firestore();

      let LISTA = [];
      let NOMES = [];
      let selecaoDiaria = [];

      let PTA_LISTA = [];
      let mostrarTodosPTA = false;
      const LIMITE_PTA = 6;

      let mostrarTodosRegistros = false;
      const LIMITE_REGISTROS = 5;

      let mostrarTodosMes = false;
      const LIMITE_MES = 6;

      const KEY_CONTRATO = "contrato_atual";
      let contratoAtual = localStorage.getItem(KEY_CONTRATO) || "ferroport";

      let allowedContracts = [];
      let isAdmin = false;

      let refDiarios = null;
      let refNomes = null;
      let refPTA = null;

      let unsubDiarios = null;
      let unsubNomes = null;
      let unsubPTA = null;

      // ===================== TEMA =====================
      const KEY_TEMA = "tema_site";
      function aplicarTema(theme){
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem(KEY_TEMA, theme);

        const txt = theme === "dark" ? "â˜€ï¸ Tema" : "ğŸŒ™ Tema";
        const btn = document.getElementById("btnTema");
        const btnLogin = document.getElementById("btnTemaLogin");
        if(btn) btn.textContent = txt;
        if(btnLogin) btnLogin.textContent = txt;

        try{ setTimeout(() => atualizarPainel(), 10); }catch(_){}
      }
      function toggleTema(){
        const atual = document.documentElement.getAttribute("data-theme") || "light";
        aplicarTema(atual === "dark" ? "light" : "dark");
      }
      window.toggleTema = toggleTema;

      const salvo = localStorage.getItem(KEY_TEMA) || "light";
      aplicarTema(salvo);

      function toggleSenha(inputId, btn){
        const input = document.getElementById(inputId);
        if(!input || !btn) return;

        const mostrando = input.type === "text";
        input.type = mostrando ? "password" : "text";

        const closed = btn.querySelector(".cam-closed");
        const open = btn.querySelector(".cam-open");
        if(closed && open){
          closed.style.display = mostrando ? "inline-flex" : "none";
          open.style.display = mostrando ? "none" : "inline-flex";
        }
      }
      window.toggleSenha = toggleSenha;

      // ===================== HELPERS =====================
      function formatarDataBR(dataISO){
        if(!dataISO) return "";
        const [y,m,d] = dataISO.split("-");
        return `${d}/${m}/${y}`;
      }
      function hojeISO(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }
      function agoraBR(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function getMesAnoSelecionado(){
        const v = document.getElementById("mesAno")?.value;
        if(!v) return null;
        const [y,m] = v.split("-");
        return { y, m };
      }
      function idSeguro(str){
        return String(str || "")
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
          .replace(/\s+/g,"-")
          .replace(/[^a-z0-9\-]/g,"")
          .slice(0,80);
      }
      function nomeContratoBonito(slug){
        return ({ "ferroport":"Ferroport", "pta-inveco":"PTA INVECO" }[slug] || slug);
      }
      function inMesAno(dataISO, y, m){
        if(!dataISO) return false;
        return dataISO.startsWith(`${y}-${m}-`);
      }

      // ===================== RANKING + GRÃFICO (CANVAS) =====================
      function contarDiasPorTecnico(itensMes){
        const map = new Map();
        itensMes.forEach(item => {
          (item.pessoas || []).forEach(nome => {
            map.set(nome, (map.get(nome) || 0) + 1);
          });
        });
        return [...map.entries()]
          .map(([nome, dias]) => ({ nome, dias }))
          .sort((a,b) => b.dias - a.dias || a.nome.localeCompare(b.nome, "pt-BR"));
      }

      function desenharGraficoTop10(canvasId, data){
        const canvas = document.getElementById(canvasId);
        if(!canvas) return;

        const w = canvas.clientWidth || 0;
        const h = canvas.clientHeight || 0;
        if(w < 50 || h < 50) return;

        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);

        const ctx = canvas.getContext("2d");
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,w,h);

        if(!data || data.length === 0){
          ctx.font = "14px Arial";
          ctx.fillStyle = "#888";
          ctx.fillText("Sem dados no mÃªs selecionado.", 12, 24);
          return;
        }

        const top = data.slice(0,10);
        const max = Math.max(...top.map(x => x.dias), 1);

        const padL = 150, padR = 18, padT = 18, padB = 18;
        const plotW = w - padL - padR;
        const rowH = Math.max(24, Math.floor((h - padT - padB) / top.length));
        const barH = Math.floor(rowH * 0.55);

        const styles = getComputedStyle(document.documentElement);
        const text = styles.getPropertyValue("--text").trim() || "#111";
        const muted = styles.getPropertyValue("--muted").trim() || "#666";
        const border = styles.getPropertyValue("--border").trim() || "#ddd";
        const bar = styles.getPropertyValue("--digital-red").trim() || "#CB3344";

        ctx.strokeStyle = border;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padL, padT);
        ctx.lineTo(padL, h - padB);
        ctx.stroke();

        ctx.font = "12px Arial";
        ctx.textBaseline = "middle";

        top.forEach((item, i) => {
          const y = padT + i * rowH + rowH/2;

          ctx.fillStyle = muted;
          const nome = item.nome.length > 22 ? item.nome.slice(0,22) + "â€¦" : item.nome;
          ctx.fillText(nome, 12, y);

          const bw = Math.max(2, (item.dias / max) * plotW);
          const x0 = padL;
          const y0 = Math.round(y - barH/2);

          ctx.fillStyle = bar;
          ctx.fillRect(x0, y0, bw, barH);

          ctx.fillStyle = text;
          ctx.fillText(String(item.dias), x0 + bw + 8, y);
        });
      }

      // ===================== PERMISSÃ•ES =====================
      async function carregarPermissoesUsuario(user){
        const snap = await db.collection("users").doc(user.uid).get();
        const data = snap.exists ? (snap.data() || {}) : {};
        allowedContracts = Array.isArray(data.allowedContracts) ? data.allowedContracts : [];
        isAdmin = String(data.role || "").toLowerCase() === "gestor";
      }

      function montarSelectContratos(){
        const sel = document.getElementById("contratoSelect");
        if(!sel) return;

        sel.innerHTML = "";

        if(!allowedContracts.length){
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Sem acesso";
          sel.appendChild(opt);
          sel.disabled = true;
          return;
        }

        sel.disabled = false;

        CONTRATOS
          .filter(c => allowedContracts.includes(c.value))
          .forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.value;
            opt.textContent = c.label;
            sel.appendChild(opt);
          });

        if(!allowedContracts.includes(contratoAtual)){
          contratoAtual = allowedContracts[0];
          localStorage.setItem(KEY_CONTRATO, contratoAtual);
        }

        sel.value = contratoAtual;
      }

      // ===================== REFS / REALTIME =====================
      function setRefsContrato(){
        refDiarios = db.collection("contratos").doc(contratoAtual).collection("diarios");
        refNomes   = db.collection("contratos").doc(contratoAtual).collection("nomes");
        refPTA     = db.collection("contratos").doc(contratoAtual).collection("ptauso");
      }

      function desligarRealtime(){
        if(typeof unsubDiarios === "function") unsubDiarios();
        if(typeof unsubNomes === "function") unsubNomes();
        if(typeof unsubPTA === "function") unsubPTA();
        unsubDiarios = unsubNomes = unsubPTA = null;
      }

      function ligarRealtime(){
        desligarRealtime();

        // âš ï¸ IMPORTANTE:
        // orderBy("dataISO") sÃ³ funciona se TODOS docs tiverem dataISO
        // e se vocÃª criar o Ã­ndice quando necessÃ¡rio.
        // Se der erro, troque para onSnapshot sem orderBy.
        unsubDiarios = refDiarios.onSnapshot(
          (snap) => {
            LISTA = snap.docs.map(d => d.data());
            carregarDiario();
            atualizarPainel();
          },
          (err) => {
            console.error("Erro diÃ¡rios:", err);
            alert("Erro diÃ¡rios:\n\n" + (err?.message || err));
          }
        );

        unsubNomes = refNomes.onSnapshot(
          (snap) => {
            NOMES = snap.docs.map(d => (d.data()||{}).nome).filter(Boolean).sort((a,b) => a.localeCompare(b, "pt-BR"));
            renderChipsDiario();
          },
          (err) => {
            console.error("Erro nomes:", err);
            alert("Erro nomes:\n\n" + (err?.message || err));
          }
        );

        unsubPTA = refPTA.onSnapshot(
          (snap) => {
            PTA_LISTA = snap.docs.map(d => ({ id: d.id, ...d.data() }))
              .sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||""));
            carregarPTA();
            atualizarPainel();
          },
          (err) => console.error("Erro PTA:", err)
        );
      }

      function mostrarBlocosContrato(){
        const isPTA = contratoAtual === "pta-inveco";
        const a = document.getElementById("blocoPTA");
        const b = document.getElementById("blocoFerroport");
        const c = document.getElementById("cardPresenca");
        const d = document.getElementById("cardListaFerroport");
        const e = document.getElementById("printPTA");
        const f = document.getElementById("printFerroport");
        if(a) a.style.display = isPTA ? "block" : "none";
        if(b) b.style.display = isPTA ? "none" : "block";
        if(c) c.style.display = isPTA ? "none" : "block";
        if(d) d.style.display = isPTA ? "none" : "block";
        if(e) e.style.display = isPTA ? "block" : "none";
        if(f) f.style.display = isPTA ? "none" : "block";
      }

      function setContrato(novo){
        if(!allowedContracts.includes(novo)){
          alert("VocÃª nÃ£o tem permissÃ£o para acessar este contrato.");
          const sel = document.getElementById("contratoSelect");
          if(sel) sel.value = contratoAtual;
          return;
        }

        contratoAtual = novo;
        localStorage.setItem(KEY_CONTRATO, contratoAtual);

        setRefsContrato();
        ligarRealtime();

        selecaoDiaria = [];
        renderChipsDiario();
        limparDiario(true);

        mostrarTodosMes = false;
        mostrarTodosRegistros = false;
        mostrarTodosPTA = false;

        mostrarBlocosContrato();
        atualizarPainel();
      }

      // ===================== AUTH =====================
      async function login(){
        const email = document.getElementById("loginEmail").value.trim();
        const senha = document.getElementById("loginSenha").value.trim();
        const msg = document.getElementById("loginMsg");
        const status = document.getElementById("loginStatus");
        const btn = document.getElementById("btnEntrar");

        if(msg) msg.textContent = "";
        if(status) status.style.display = "flex";
        if(btn) btn.disabled = true;

        try{
          await auth.signInWithEmailAndPassword(email, senha);
        }catch(e){
          if(msg) msg.textContent = "Falha no login: " + (e?.code || e?.message || e);
          if(status) status.style.display = "none";
          if(btn) btn.disabled = false;
        }
      }
      window.login = login;

      async function esqueciSenha(){
        const email = document.getElementById("loginEmail").value.trim();
        const msg = document.getElementById("loginMsg");
        if(msg) msg.textContent = "";

        if(!email){
          if(msg) msg.textContent = "Digite seu e-mail para receber o link de redefiniÃ§Ã£o.";
          return;
        }

        try{
          await auth.sendPasswordResetEmail(email);
          if(msg) msg.textContent = "Pronto! Enviamos um e-mail para redefinir sua senha.";
        }catch(e){
          if(msg) msg.textContent = "NÃ£o foi possÃ­vel enviar: " + (e?.code || e?.message || e);
        }
      }
      window.esqueciSenha = esqueciSenha;

      async function logout(){ await auth.signOut(); }
      window.logout = logout;

      function mostrarApp(logado){
        const a = document.getElementById("loginBox");
        const b = document.getElementById("appRoot");
        if(a) a.style.display = logado ? "none" : "flex";
        if(b) b.style.display = logado ? "block" : "none";
      }

      function aplicarPermissoesUI(){
        const pill = document.getElementById("rolePill");
        const permMsg = document.getElementById("permMsg");
        const btnApagarTudo = document.getElementById("btnApagarTudo");

        if(pill){
          pill.textContent = isAdmin ? "Gestor" : "TÃ©cnico";
          pill.classList.toggle("admin", isAdmin);
        }

        if(btnApagarTudo) btnApagarTudo.style.display = isAdmin ? "inline-block" : "none";
        if(permMsg) permMsg.style.display = isAdmin ? "none" : "block";
      }

      // ===================== CHIPS =====================
      function renderChipsDiario(){
        const wrap = document.getElementById("chipsDiario");
        if(!wrap) return;
        wrap.innerHTML = "";

        NOMES.forEach(nome => {
          const box = document.createElement("div");
          box.className = "chip-box";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "chip" + (selecaoDiaria.includes(nome) ? " active" : "");
          btn.innerText = nome;

          btn.onclick = () => {
            selecaoDiaria = selecaoDiaria.includes(nome)
              ? selecaoDiaria.filter(n => n !== nome)
              : [...selecaoDiaria, nome];
            renderChipsDiario();
          };

          const remover = document.createElement("span");
          remover.className = "remove";
          remover.title = "Excluir nome (gestor)";
          remover.innerText = "âœ–";
          remover.style.display = isAdmin ? "inline-flex" : "none";
          remover.onclick = (e) => { e.stopPropagation(); excluirNome(nome); };

          box.appendChild(btn);
          box.appendChild(remover);
          wrap.appendChild(box);
        });
      }
      window.renderChipsDiario = renderChipsDiario;

      async function adicionarNome(){
        try{
          const input = document.getElementById("novoNome");
          const nome = input.value.trim();
          if(!nome) return alert("Digite um nome.");

          const existe = NOMES.some(n => n.toLowerCase() === nome.toLowerCase());
          if(existe) return alert("Esse nome jÃ¡ existe.");

          await refNomes.doc(idSeguro(nome)).set({ nome });
          input.value = "";
        }catch(e){
          console.error(e);
          alert("Erro ao adicionar nome:\n\n" + (e?.message || e));
        }
      }
      window.adicionarNome = adicionarNome;

      async function excluirNome(nome){
        if(!isAdmin) return alert("Somente gestor pode excluir nomes.");
        if(!confirm(`Deseja excluir "${nome}"?`)) return;
        await refNomes.doc(idSeguro(nome)).delete();
        selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
      }

      // ===================== DIÃRIOS =====================
      async function salvarDiario(){
        try{
          const data = document.getElementById("dataDia").value;
          if(!data) return alert("Selecione a data.");
          if(selecaoDiaria.length === 0) return alert("Selecione pelo menos uma pessoa.");

          const item = { dataISO: data, dataBR: formatarDataBR(data), pessoas: [...selecaoDiaria] };
          await refDiarios.doc(data).set(item);

          limparDiario();
        }catch(e){
          console.error(e);
          alert("Erro ao salvar o dia:\n\n" + (e?.message || e));
        }
      }
      window.salvarDiario = salvarDiario;

      function limparDiario(silencioso=false){
        const dataDia = document.getElementById("dataDia");
        if(dataDia) dataDia.value = hojeISO();
        selecaoDiaria = [];
        renderChipsDiario();
        if(!silencioso){
          const novoNome = document.getElementById("novoNome");
          if(novoNome) novoNome.value = "";
        }
      }
      window.limparDiario = limparDiario;

      function carregarDiario(){
        const tbody = document.getElementById("tabelaDiario");
        if(!tbody) return;

        tbody.innerHTML = "";

        const dados = [...LISTA].sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||""));
        const visiveis = mostrarTodosRegistros ? dados : dados.slice(0, LIMITE_REGISTROS);

        visiveis.forEach(item => {
          const tr = document.createElement("tr");

          const tdData = document.createElement("td");
          tdData.textContent = item.dataBR || formatarDataBR(item.dataISO);

          const tdPessoas = document.createElement("td");
          tdPessoas.textContent = Array.isArray(item.pessoas) ? item.pessoas.join(", ") : "";

          const tdAcoes = document.createElement("td");
          tdAcoes.className = "row-actions";

          const btnEditar = document.createElement("button");
          btnEditar.className = "btn secondary small";
          btnEditar.type = "button";
          btnEditar.textContent = "Editar";
          btnEditar.onclick = () => {
            document.getElementById("dataDia").value = item.dataISO || hojeISO();
            selecaoDiaria = Array.isArray(item.pessoas) ? [...item.pessoas] : [];
            renderChipsDiario();
            document.getElementById("cardPresenca")?.scrollIntoView({ behavior:"smooth", block:"start" });
          };
          tdAcoes.appendChild(btnEditar);

          if(isAdmin){
            const btnExcluir = document.createElement("button");
            btnExcluir.className = "btn danger small";
            btnExcluir.type = "button";
            btnExcluir.textContent = "Excluir";
            btnExcluir.onclick = async () => {
              if(!confirm(`Excluir o dia ${item.dataBR || item.dataISO}?`)) return;
              await refDiarios.doc(item.dataISO).delete();
            };
            tdAcoes.appendChild(btnExcluir);
          }

          tr.appendChild(tdData);
          tr.appendChild(tdPessoas);
          tr.appendChild(tdAcoes);
          tbody.appendChild(tr);
        });

        atualizarBotaoVerMais();
      }

      function atualizarBotaoVerMais(){
        const btn = document.getElementById("btnVerMais");
        if(!btn) return;
        btn.style.display = LISTA.length > LIMITE_REGISTROS ? "inline-block" : "none";
        btn.textContent = mostrarTodosRegistros ? "Ver menos" : "Ver mais registros";
      }

      function toggleVerMais(){
        mostrarTodosRegistros = !mostrarTodosRegistros;
        carregarDiario();
      }
      window.toggleVerMais = toggleVerMais;

      async function apagarDiarios(){
        if(!isAdmin) return alert("Somente gestor pode apagar tudo.");
        if(!confirm("Tem certeza que deseja apagar TODOS os diÃ¡rios deste contrato?")) return;

        const snap = await refDiarios.get();
        const batch = db.batch();
        snap.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("Todos os diÃ¡rios foram apagados.");
      }
      window.apagarDiarios = apagarDiarios;

      function exportarDiarioCSV(){
        const header = ["Data", "Pessoas"];
        const linhas = [...LISTA]
          .sort((a,b)=> (a.dataISO||"").localeCompare(b.dataISO||""))
          .map(item => {
            const data = item.dataBR || formatarDataBR(item.dataISO);
            const pessoas = Array.isArray(item.pessoas) ? item.pessoas.join(" | ") : "";
            return [`"${data}"`, `"${pessoas.replaceAll('"','""')}"`].join(",");
          });

        const csv = [header.join(","), ...linhas].join("\n");
        const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `diario_${contratoAtual}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      window.exportarDiarioCSV = exportarDiarioCSV;

      // ===================== PTA (mÃ­nimo) =====================
      function carregarPTA(){
        const tbody = document.getElementById("tabelaPTA");
        if(!tbody) return;
        tbody.innerHTML = "";
      }
      window.toggleVerMaisPTA = function(){ mostrarTodosPTA = !mostrarTodosPTA; carregarPTA(); };

      window.salvarPTA = function(){ alert("Ainda falta implementar salvarPTA()."); };
      window.limparPTA = function(){};
      window.limparAssinatura = function(){};

      // ===================== PAINEL =====================
      function carregarMes(itensMes){
        const tbody = document.getElementById("tabelaMes");
        if(tbody){
          tbody.innerHTML = "";
          const vis = mostrarTodosMes ? itensMes : itensMes.slice(0, LIMITE_MES);

          vis.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML =
              `<td>${item.dataBR || formatarDataBR(item.dataISO)}</td>` +
              `<td>${Array.isArray(item.pessoas) ? item.pessoas.join(", ") : ""}</td>`;
            tbody.appendChild(tr);
          });

          const btn = document.getElementById("btnVerMaisMes");
          if(btn){
            btn.style.display = itensMes.length > LIMITE_MES ? "inline-block" : "none";
            btn.textContent = mostrarTodosMes ? "Ver menos registros" : "Ver mais registros";
          }
        }

        const pMes = document.getElementById("printMes");
        if(pMes){
          pMes.innerHTML = "";
          itensMes.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML =
              `<td>${item.dataBR || formatarDataBR(item.dataISO)}</td>` +
              `<td>${Array.isArray(item.pessoas) ? item.pessoas.join(", ") : ""}</td>`;
            pMes.appendChild(tr);
          });
        }
      }

      function toggleVerMaisMes(){
        mostrarTodosMes = !mostrarTodosMes;
        atualizarPainel();
      }
      window.toggleVerMaisMes = toggleVerMaisMes;

      function atualizarPainel(){
        const sel = getMesAnoSelecionado();
        if(!sel){
          const hoje = new Date();
          const pad = (n)=> String(n).padStart(2,"0");
          document.getElementById("mesAno").value = `${hoje.getFullYear()}-${pad(hoje.getMonth()+1)}`;
          return;
        }

        document.getElementById("reportContrato").textContent = nomeContratoBonito(contratoAtual);
        document.getElementById("reportPeriodo").innerText = `PerÃ­odo: ${sel.m}/${sel.y}`;
        document.getElementById("reportGeradoEm").innerText = `Gerado em: ${agoraBR()}`;

        if(contratoAtual !== "ferroport") return;

        const itensMes = [...LISTA]
          .filter(x => inMesAno(x.dataISO, sel.y, sel.m))
          .sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||""));

        const dias = itensMes.length;
        const presencas = itensMes.reduce((acc, x)=> acc + (Array.isArray(x.pessoas) ? x.pessoas.length : 0), 0);

        const setTec = new Set();
        itensMes.forEach(x => (x.pessoas||[]).forEach(p => setTec.add(p)));

        document.getElementById("kpiDias").textContent = String(dias);
        document.getElementById("kpiPresencas").textContent = String(presencas);
        document.getElementById("kpiTecnicos").textContent = String(setTec.size);

        carregarMes(itensMes);

        const ranking = contarDiasPorTecnico(itensMes);

        const tbodyRank = document.getElementById("tabelaRanking");
        if(tbodyRank){
          tbodyRank.innerHTML = "";
          const top10 = ranking.slice(0,10);
          const maxDias = Math.max(...top10.map(x => x.dias), 1);

          top10.forEach((r, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML =
              `<td>${idx+1}</td>` +
              `<td>${r.nome}</td>` +
              `<td>${r.dias}</td>` +
              `<td><div class="bar"><div class="bar-fill" style="width:${Math.round((r.dias/maxDias)*100)}%"></div></div></td>`;
            tbodyRank.appendChild(tr);
          });
        }

        const pRank = document.getElementById("printRanking");
        if(pRank){
          pRank.innerHTML = "";
          ranking.slice(0, 40).forEach((r, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${idx+1}</td><td>${r.nome}</td><td>${r.dias}</td>`;
            pRank.appendChild(tr);
          });
        }

        const top1 = ranking[0] || { nome:"â€”", dias:0 };
        document.getElementById("insightTopNome").textContent = top1.nome;
        document.getElementById("insightTopDias").textContent = String(top1.dias);
        document.getElementById("insightMediaDia").textContent = String(dias ? (presencas / dias).toFixed(1) : 0);
        document.getElementById("insightMediaTec").textContent = String(ranking.length ? (dias / ranking.length).toFixed(1) : 0);

        // âœ… desenha depois que layout existe
        setTimeout(() => desenharGraficoTop10("chartRanking", ranking), 0);
      }
      window.atualizarPainel = atualizarPainel;

      function gerarPDF(){
        atualizarPainel();
        setTimeout(()=> window.print(), 50);
      }
      window.gerarPDF = gerarPDF;

      // ===================== INIT =====================
      function initUI(){
        const selContrato = document.getElementById("contratoSelect");
        if(selContrato){
          selContrato.addEventListener("change", ()=> setContrato(selContrato.value));
        }

        const dataDia = document.getElementById("dataDia");
        if(dataDia) dataDia.value = hojeISO();

        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        const mesAno = document.getElementById("mesAno");
        if(mesAno){
          mesAno.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
          mesAno.addEventListener("change", atualizarPainel);
        }

        mostrarBlocosContrato();

        window.addEventListener("resize", () => {
          try{ atualizarPainel(); }catch(_){}
        });
      }

      auth.onAuthStateChanged(async (user) => {
        const msg = document.getElementById("loginMsg");

        if(!user){
          mostrarApp(false);
          desligarRealtime();
          const status = document.getElementById("loginStatus");
          if(status) status.style.display = "none";
          const btn = document.getElementById("btnEntrar");
          if(btn) btn.disabled = false;
          return;
        }

        try{
          await carregarPermissoesUsuario(user);

          if(!allowedContracts.length){
            mostrarApp(false);
            if(msg) msg.textContent = "Seu usuÃ¡rio nÃ£o tem acesso a nenhum contrato. PeÃ§a liberaÃ§Ã£o ao gestor.";
            await auth.signOut();
            return;
          }

          montarSelectContratos();

          document.getElementById("userBadge").textContent = `Logado como: ${user.email || "â€”"}`;
          aplicarPermissoesUI();
          mostrarApp(true);

          setRefsContrato();
          ligarRealtime();
          initUI();

          setTimeout(() => atualizarPainel(), 120);
        }catch(e){
          showFatal(e);
          await auth.signOut();
        }
      });

      // âœ… refs inicial
      setRefsContrato();

    }catch(err){
      showFatal(err);
    }
  });
})();
</script>

</body>
</html>
