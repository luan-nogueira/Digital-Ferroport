<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presen√ßa di√°ria ‚Äî Ferroport</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="style.css" />

  <!-- Biblioteca para gerar PDF -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* √Årea do relat√≥rio escondida (s√≥ usada para gerar PDF) */
    #relatorioPdfArea{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 794px; /* ~ A4 em px (96dpi) */
      background: #fff;
      color: #1E2328;
      font-family: Arial, sans-serif;
    }
    /* Estilo do relat√≥rio (bonito e corporativo) */
    .pdf-wrap{ padding: 28px; }
    .pdf-top{
      display:flex;
      align-items:center;
      gap:16px;
      border-bottom:2px solid #E6E8EE;
      padding-bottom:14px;
      margin-bottom:14px;
    }
    .pdf-logos{ display:flex; align-items:center; gap:14px; }
    .pdf-logo{ height:52px; width:auto; object-fit:contain; display:block; }
    .pdf-logo.emive{ height:72px; }
    .pdf-title{ margin:0; font-size:18px; font-weight:800; }
    .pdf-sub{ margin-top:4px; color:#6B7280; font-size:12px; }
    .pdf-badges{ margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; }
    .pdf-badge{
      display:inline-block;
      border:1px solid #E6E8EE;
      border-radius:999px;
      padding:6px 10px;
      background:#fafafa;
      font-size:12px;
      color:#36393B;
    }
    .pdf-grid{
      display:grid;
      grid-template-columns: 1.25fr 0.75fr;
      gap: 14px;
      margin-top: 14px;
    }
    .pdf-box{
      border:1px solid #E6E8EE;
      border-radius:14px;
      padding:12px;
    }
    .pdf-box h3{
      margin:0 0 8px 0;
      font-size:13px;
      font-weight:800;
    }
    .pdf-table{
      width:100%;
      border-collapse:collapse;
      margin-top: 6px;
      font-size:12px;
    }
    .pdf-table th, .pdf-table td{
      border:1px solid #E6E8EE;
      padding:8px;
      vertical-align:top;
    }
    .pdf-table th{
      background:#f3f4f6;
      text-align:center;
      font-weight:800;
    }
    .pdf-table td:first-child{
      width:120px;
      text-align:center;
      font-weight:700;
    }
    .pdf-list{
      margin:0;
      padding-left:16px;
      font-size:12px;
    }
    .pdf-footer{
      margin-top:16px;
      padding-top:10px;
      border-top:1px solid #E6E8EE;
      text-align:center;
      color:#6B7280;
      font-size:11px;
    }
  </style>
</head>

<body>

<header class="topbar">
  <div class="brand">

    <div class="logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div class="brand-text">
      <div class="brand-title">Presen√ßa di√°ria ‚Äî Ferroport</div>
      <div class="brand-subtitle">Controle de t√©cnicos no contrato</div>
    </div>

  </div>
</header>

<main class="container">

  <section class="card">
    <div class="card-head">
      <h2>Presen√ßa por dia</h2>
      <p class="muted">Selecione a data e marque quem esteve no contrato.</p>
    </div>

    <div class="grid-2">
      <div class="field">
        <label>Data</label>
        <input id="dataDia" type="date" />
      </div>

      <div class="field">
        <label>Pessoas</label>

        <div class="chips" id="chipsDiario"></div>

        <div class="add-nome">
          <input type="text" id="novoNome" placeholder="Adicionar t√©cnico (ex: Jo√£o Silva)">
          <button class="btn" type="button" onclick="adicionarNome()">+ Adicionar</button>
        </div>

        <p class="muted small">Os nomes ficam salvos no navegador.</p>
      </div>
    </div>

    <div class="actions">
      <button class="btn" onclick="salvarDiario()">üíæ Salvar dia</button>
      <button class="btn secondary" onclick="limparDiario()">üßπ Limpar</button>
      <button class="btn danger" onclick="apagarDiarios()">üóë Apagar tudo</button>
      <button class="btn" onclick="exportarDiarioCSV()">‚¨á Exportar CSV</button>
      <button class="btn" onclick="baixarPdfMensal()">üìÑ Baixar PDF (mensal)</button>
    </div>
  </section>

  <section class="card">
    <div class="card-head">
      <h2>Presen√ßas registradas</h2>
      <p class="muted">Se salvar a mesma data novamente, o sistema atualiza.</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>T√©cnicos presentes</th>
        </tr>
      </thead>
      <tbody id="tabelaDiario"></tbody>
    </table>
  </section>

  <footer class="footer">
    DIGITAL ‚Ä¢ EMIVE ‚Ä¢ Tecnologia e Seguran√ßa
  </footer>

</main>

<!-- √Årea escondida do PDF -->
<div id="relatorioPdfArea">
  <div class="pdf-wrap">
    <div class="pdf-top">
      <div class="pdf-logos">
        <img src="logo-digital.png" class="pdf-logo" alt="Digital">
        <img src="logo-emive.png" class="pdf-logo emive" alt="Emive">
      </div>

      <div>
        <h1 class="pdf-title">Relat√≥rio Mensal de Presen√ßa</h1>
        <div class="pdf-sub">Contrato: Ferroport</div>
        <div class="pdf-badges">
          <span class="pdf-badge" id="pdfBadgeMesAno"><strong>M√™s:</strong> ‚Äî</span>
          <span class="pdf-badge" id="pdfBadgeRegistros"><strong>Registros:</strong> ‚Äî</span>
        </div>
      </div>
    </div>

    <div class="pdf-grid">
      <div class="pdf-box">
        <h3>Presen√ßas por dia</h3>
        <table class="pdf-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>T√©cnicos presentes</th>
            </tr>
          </thead>
          <tbody id="pdfTabelaLinhas"></tbody>
        </table>
      </div>

      <div class="pdf-box">
        <h3>Resumo do m√™s (dias por t√©cnico)</h3>
        <ul class="pdf-list" id="pdfResumo"></ul>
      </div>
    </div>

    <div class="pdf-footer">
      DIGITAL ‚Ä¢ EMIVE ‚Äî Tecnologia e Seguran√ßa
    </div>
  </div>
</div>

<script>
  const KEY_DIARIOS = "presencas_diarias";
  const KEY_NOMES = "nomes_tecnicos";

  const NOMES_PADRAO = ["Luan Nogueira", "Lucas Gregorio", "Phillipe Carvalho"];
  let NOMES = JSON.parse(localStorage.getItem(KEY_NOMES)) || [...NOMES_PADRAO];

  let selecaoDiaria = [];

  const nomesMes = {
    "01":"Janeiro","02":"Fevereiro","03":"Mar√ßo","04":"Abril",
    "05":"Maio","06":"Junho","07":"Julho","08":"Agosto",
    "09":"Setembro","10":"Outubro","11":"Novembro","12":"Dezembro"
  };

  function salvarNomes(){
    localStorage.setItem(KEY_NOMES, JSON.stringify(NOMES));
  }

  function formatarDataBR(dataISO){
    const [y,m,d] = dataISO.split("-");
    return `${d}/${m}/${y}`;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function renderChipsDiario(){
    const wrap = document.getElementById("chipsDiario");
    wrap.innerHTML = "";

    NOMES.forEach(nome => {
      const box = document.createElement("div");
      box.className = "chip-box";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (selecaoDiaria.includes(nome) ? " active" : "");
      btn.innerText = nome;

      btn.onclick = () => {
        if (selecaoDiaria.includes(nome)) {
          selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
        } else {
          selecaoDiaria.push(nome);
        }
        renderChipsDiario();
      };

      const remover = document.createElement("span");
      remover.className = "remove";
      remover.title = "Excluir nome";
      remover.innerText = "‚úñ";

      remover.onclick = (e) => {
        e.stopPropagation();
        excluirNome(nome);
      };

      box.appendChild(btn);
      box.appendChild(remover);
      wrap.appendChild(box);
    });
  }

  function adicionarNome(){
    const input = document.getElementById("novoNome");
    const nome = input.value.trim();

    if(!nome){ alert("Digite um nome."); return; }

    const existe = NOMES.some(n => n.toLowerCase() === nome.toLowerCase());
    if(existe){ alert("Esse nome j√° existe."); return; }

    NOMES.push(nome);
    NOMES.sort((a,b) => a.localeCompare(b, "pt-BR"));
    salvarNomes();

    input.value = "";
    renderChipsDiario();
  }

  function excluirNome(nome){
    if(!confirm(`Deseja excluir "${nome}"?`)) return;

    NOMES = NOMES.filter(n => n !== nome);
    selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
    salvarNomes();
    renderChipsDiario();
  }

  function salvarDiario(){
    const data = document.getElementById("dataDia").value;

    if(!data){ alert("Selecione a data."); return; }
    if(selecaoDiaria.length === 0){ alert("Selecione pelo menos uma pessoa."); return; }

    const item = {
      dataISO: data,
      dataBR: formatarDataBR(data),
      pessoas: [...selecaoDiaria]
    };

    let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");
    const idx = lista.findIndex(x => x.dataISO === data);
    if(idx >= 0) lista[idx] = item;
    else lista.push(item);

    lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO));
    localStorage.setItem(KEY_DIARIOS, JSON.stringify(lista));

    carregarDiario();
    limparDiario();
  }

  function carregarDiario(){
    const tbody = document.getElementById("tabelaDiario");
    tbody.innerHTML = "";

    let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");
    lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO));

    lista.forEach(r => {
      tbody.innerHTML += `
        <tr>
          <td><strong>${escapeHtml(r.dataBR)}</strong></td>
          <td>${(r.pessoas || []).map(escapeHtml).join("<br>")}</td>
        </tr>
      `;
    });
  }

  function limparDiario(){
    document.getElementById("dataDia").value = "";
    selecaoDiaria = [];
    renderChipsDiario();
  }

  function apagarDiarios(){
    if(confirm("Deseja apagar todos os registros?")){
      localStorage.removeItem(KEY_DIARIOS);
      carregarDiario();
    }
  }

  function exportarDiarioCSV(){
    let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");
    if(lista.length === 0){ alert("N√£o h√° registros para exportar."); return; }

    lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO));

    let csv = "Data;Pessoas\n";
    lista.forEach(r => {
      csv += `${r.dataBR};"${(r.pessoas || []).join(", ")}"\n`;
    });

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "presencas_ferroport.csv";
    link.click();
  }

  // === PDF AUTOM√ÅTICO (mensal) ===
  function baixarPdfMensal(){
    if (typeof html2pdf === "undefined") {
      alert("A biblioteca de PDF ainda n√£o carregou. Aguarde 2 segundos e tente novamente.");
      return;
    }

    let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");
    if(lista.length === 0){ alert("N√£o h√° dados para gerar PDF."); return; }

    lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO));

    // Pega m√™s/ano do primeiro item
    const [ano, mes] = (lista[0].dataISO || "0000-00-00").split("-");
    const mesNome = nomesMes[mes] || "Mes";

    // Filtra apenas registros do m√™s (primeiro m√™s encontrado)
    const listaMes = lista.filter(x => (x.dataISO || "").startsWith(`${ano}-${mes}`));

    // Preenche badges
    document.getElementById("pdfBadgeMesAno").innerHTML = `<strong>M√™s:</strong> ${escapeHtml(mesNome)} / ${escapeHtml(ano)}`;
    document.getElementById("pdfBadgeRegistros").innerHTML = `<strong>Registros:</strong> ${listaMes.length}`;

    // Monta tabela do PDF
    const tbody = document.getElementById("pdfTabelaLinhas");
    tbody.innerHTML = "";
    listaMes.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.dataBR)}</td>
        <td>${escapeHtml((r.pessoas || []).join(", "))}</td>
      `;
      tbody.appendChild(tr);
    });

    // Resumo por t√©cnico
    const totals = {};
    listaMes.forEach(r => (r.pessoas || []).forEach(p => totals[p] = (totals[p] || 0) + 1));
    const resumoEl = document.getElementById("pdfResumo");
    resumoEl.innerHTML = "";

    const tecnicos = Object.keys(totals).sort((a,b)=>a.localeCompare(b,"pt-BR"));
    if (tecnicos.length === 0) {
      resumoEl.innerHTML = "<li>Nenhum dado.</li>";
    } else {
      tecnicos.forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${escapeHtml(t)}</strong>: ${totals[t]} dia(s)`;
        resumoEl.appendChild(li);
      });
    }

    const area = document.getElementById("relatorioPdfArea");

    // Nome do arquivo
    const fileName = `Relatorio_Ferroport_${mesNome}_${ano}.pdf`
      .replace(/\s+/g, "_")
      .replace(/[√ß√á]/g, "c")
      .replace(/[√£√É]/g, "a")
      .replace(/[√µ√ï]/g, "o")
      .replace(/[√°√†√¢√§√Å√Ä√Ç√Ñ]/g, "a")
      .replace(/[√©√®√™√´√â√à√ä√ã]/g, "e")
      .replace(/[√≠√¨√Æ√Ø√ç√å√é√è]/g, "i")
      .replace(/[√≥√≤√¥√∂√ì√í√î√ñ]/g, "o")
      .replace(/[√∫√π√ª√º√ö√ô√õ√ú]/g, "u");

    const opt = {
      margin:       10,
      filename:     fileName,
      image:        { type: "jpeg", quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: "mm", format: "a4", orientation: "portrait" }
    };

    html2pdf().set(opt).from(area).save();
  }

  // Inicializa
  salvarNomes();
  renderChipsDiario();
  carregarDiario();
</script>

</body>
</html>
