<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PresenÃ§a diÃ¡ria â€” Ferroport</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header class="topbar">
  <div class="brand">

    <div class="logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div>
      <div class="brand-title">PresenÃ§a diÃ¡ria â€” Ferroport</div>
      <div class="brand-subtitle">Controle de tÃ©cnicos no contrato</div>
    </div>

  </div>
</header>

<main class="container">

<section class="card">
  <div class="card-head">
    <h2>PresenÃ§a por dia</h2>
    <p class="muted">Selecione a data e marque quem esteve no contrato.</p>
  </div>

  <div class="grid-2">
    <div class="field">
      <label>Data</label>
      <input id="dataDia" type="date" />
    </div>

    <div class="field">
      <label>Pessoas</label>

      <div class="chips" id="chipsDiario"></div>

      <div class="add-nome">
        <input type="text" id="novoNome" placeholder="Adicionar tÃ©cnico">
        <button class="btn" type="button" onclick="adicionarNome()">+ Adicionar</button>
      </div>

      <p class="muted small">Os nomes ficam salvos no navegador.</p>
    </div>
  </div>

  <div class="actions">
    <button class="btn" onclick="salvarDiario()">ðŸ’¾ Salvar dia</button>
    <button class="btn secondary" onclick="limparDiario()">ðŸ§¹ Limpar</button>
    <button class="btn danger" onclick="apagarDiarios()">ðŸ—‘ Apagar tudo</button>
    <button class="btn" onclick="exportarDiarioCSV()">â¬‡ Exportar Excel</button>
  </div>
</section>

<section class="card">
  <div class="card-head">
    <h2>PresenÃ§as registradas</h2>
    <p class="muted">Cada linha possui um botÃ£o para apagar somente aquele dia.</p>
  </div>

  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Pessoas</th>
        <th>AÃ§Ãµes</th>
      </tr>
    </thead>
    <tbody id="tabelaDiario"></tbody>
  </table>
</section>

<footer class="footer">
DIGITAL â€¢ EMIVE â€¢ Tecnologia e SeguranÃ§a
</footer>

</main>

<script>

const KEY_DIARIOS = "presencas_diarias";
const KEY_NOMES = "nomes_tecnicos";

const NOMES_PADRAO = ["Luan Nogueira", "Lucas Gregorio", "Phillipe Carvalho"];
let NOMES = JSON.parse(localStorage.getItem(KEY_NOMES)) || [...NOMES_PADRAO];

let selecaoDiaria = [];

function salvarNomes(){
  localStorage.setItem(KEY_NOMES, JSON.stringify(NOMES));
}

function formatarDataBR(dataISO){
  const [y,m,d] = dataISO.split("-");
  return `${d}/${m}/${y}`;
}

function renderChipsDiario(){
  const wrap = document.getElementById("chipsDiario");
  wrap.innerHTML = "";

  NOMES.forEach(nome => {
    const btn = document.createElement("button");
    btn.className = "chip";
    btn.innerText = nome;

    btn.onclick = () => {
      if (selecaoDiaria.includes(nome)) {
        selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
        btn.classList.remove("active");
      } else {
        selecaoDiaria.push(nome);
        btn.classList.add("active");
      }
    };

    wrap.appendChild(btn);
  });
}

function adicionarNome(){
  const input = document.getElementById("novoNome");
  const nome = input.value.trim();

  if(!nome) return alert("Digite um nome.");

  NOMES.push(nome);
  salvarNomes();
  input.value = "";
  renderChipsDiario();
}

function salvarDiario(){
  const data = document.getElementById("dataDia").value;

  if(!data) return alert("Selecione a data.");
  if(selecaoDiaria.length === 0) return alert("Selecione pessoas.");

  const item = {
    dataISO: data,
    dataBR: formatarDataBR(data),
    pessoas: [...selecaoDiaria]
  };

  let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

  const idx = lista.findIndex(x => x.dataISO === data);
  if(idx >= 0) lista[idx] = item;
  else lista.push(item);

  localStorage.setItem(KEY_DIARIOS, JSON.stringify(lista));

  carregarDiario();
  limparDiario();
}

function carregarDiario(){
  const tbody = document.getElementById("tabelaDiario");
  tbody.innerHTML = "";

  let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

  lista.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td><strong>${r.dataBR}</strong></td>
        <td>${r.pessoas.join("<br>")}</td>
        <td>
          <button onclick="excluirDia('${r.dataISO}')" class="btn danger">ðŸ—‘ Apagar dia</button>
        </td>
      </tr>
    `;
  });
}

function excluirDia(dataISO){

  if(!confirm("Deseja apagar somente este dia?")) return;

  let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

  lista = lista.filter(item => item.dataISO !== dataISO);

  localStorage.setItem(KEY_DIARIOS, JSON.stringify(lista));

  carregarDiario();
}

function limparDiario(){
  document.getElementById("dataDia").value = "";
  selecaoDiaria = [];
  renderChipsDiario();
}

function apagarDiarios(){
  if(confirm("Apagar TODOS os registros?")){
    localStorage.removeItem(KEY_DIARIOS);
    carregarDiario();
  }
}

function exportarDiarioCSV(){
  let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

  let csv = "Data;Pessoas\n";
  lista.forEach(r => {
    csv += `${r.dataBR};"${r.pessoas.join(", ")}"\n`;
  });

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "presencas_ferroport.csv";
  link.click();
}

renderChipsDiario();
carregarDiario();

</script>

</body>
</html>
