<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PresenÃ§a diÃ¡ria â€” Ferroport</title>
<link rel="stylesheet" href="style.css" />
</head>

<body>

<header class="topbar">
  <div class="brand">

    <div class="logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div>
      <div class="brand-title">PresenÃ§a diÃ¡ria â€” Ferroport</div>
      <div class="brand-subtitle">Controle de tÃ©cnicos no contrato</div>
    </div>

  </div>
</header>

<main class="container">

<section class="card" id="cardPresenca">
  <div class="card-head">
    <h2>PresenÃ§a por dia</h2>
    <p class="muted">Selecione a data e marque quem esteve no contrato.</p>
  </div>

  <div class="grid-2">
    <div class="field">
      <label>Data</label>
      <input id="dataDia" type="date" />
    </div>

    <div class="field">
      <label>Pessoas</label>

      <div class="chips" id="chipsDiario"></div>

      <div class="add-nome">
        <input type="text" id="novoNome" placeholder="Adicionar tÃ©cnico (ex: JoÃ£o Silva)">
        <button class="btn" type="button" onclick="adicionarNome()">+ Adicionar</button>
      </div>

      <p class="muted small">Os nomes ficam salvos no navegador.</p>
    </div>
  </div>

  <div class="actions">
    <button class="btn" onclick="salvarDiario()">ğŸ’¾ Salvar dia</button>
    <button class="btn secondary" onclick="limparDiario()">ğŸ§¹ Limpar</button>
    <button class="btn danger" onclick="apagarDiarios()">ğŸ—‘ Apagar tudo</button>
    <button class="btn" onclick="exportarDiarioCSV()">â¬‡ Exportar Excel</button>
  </div>
</section>

<section class="card">
  <div class="card-head">
    <h2>PresenÃ§as registradas</h2>
    <p class="muted">Se salvar a mesma data novamente, o sistema atualiza. Use â€œEditarâ€ para carregar um registro.</p>
  </div>

  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Pessoas</th>
        <th>AÃ§Ãµes</th>
      </tr>
    </thead>
    <tbody id="tabelaDiario"></tbody>
  </table>
</section>

<footer class="footer">
  DIGITAL â€¢ EMIVE â€¢ Tecnologia e SeguranÃ§a
</footer>

</main>

<script>
const KEY_DIARIOS = "presencas_diarias";
const KEY_NOMES = "nomes_tecnicos";

const NOMES_PADRAO = ["Luan Nogueira", "Lucas Gregorio", "Phillipe Carvalho"];
let NOMES = JSON.parse(localStorage.getItem(KEY_NOMES)) || [...NOMES_PADRAO];

let selecaoDiaria = [];

function salvarNomes(){
  localStorage.setItem(KEY_NOMES, JSON.stringify(NOMES));
}

function formatarDataBR(dataISO){
  const [y,m,d] = dataISO.split("-");
  return `${d}/${m}/${y}`;
}

// Render dos nomes com botÃ£o de excluir
function renderChipsDiario(){
  const wrap = document.getElementById("chipsDiario");
  wrap.innerHTML = "";

  NOMES.forEach(nome => {
    const box = document.createElement("div");
    box.className = "chip-box";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "chip" + (selecaoDiaria.includes(nome) ? " active" : "");
    btn.innerText = nome;

    btn.onclick = () => {
      if (selecaoDiaria.includes(nome)) {
        selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
      } else {
        selecaoDiaria.push(nome);
      }
      renderChipsDiario();
    };

    const remover = document.createElement("span");
    remover.className = "remove";
    remover.title = "Excluir nome";
    remover.innerText = "âœ–";

    remover.onclick = (e) => {
      e.stopPropagation();
      excluirNome(nome);
    };

    box.appendChild(btn);
    box.appendChild(remover);
    wrap.appendChild(box);
  });
}

function adicionarNome(){
  const input = document.getElementById("novoNome");
  const nome = input.value.trim();

  if(!nome){
    alert("Digite um nome.");
    return;
  }

  const existe = NOMES.some(n => n.toLowerCase() === nome.toLowerCase());
  if(existe){
    alert("Esse nome jÃ¡ existe.");
    return;
  }

  NOMES.push(nome);
  NOMES.sort((a,b) => a.localeCompare(b, "pt-BR"));
  salvarNomes();

  input.value = "";
  renderChipsDiario();
}

function excluirNome(nome){
  if(!confirm(`Deseja excluir "${nome}"?`)) return;

  NOMES = NOMES.filter(n => n !== nome);
  selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
  salvarNomes();
  renderChipsDiario();
}

function salvarDiario(){
  const data = document.getElementById("dataDia").value;

  if(!data){
    alert("Selecione a data.");
    return;
  }

  if(selecaoDiaria.length === 0){
    alert("Selecione pelo menos uma pessoa.");
    return;
  }

  const item = {
    dataISO: data,
    dataBR: formatarDataBR(data),
    pessoas: [...selecaoDiaria]
  };

  let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

  // Atualiza se jÃ¡ existir a data
  const idx = lista.findIndex(x => x.dataISO === data);
  if(idx >= 0) lista[idx] = item;
  else lista.push(item);

  // Ordena por data
  lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO));

  localStorage.setItem(KEY_DIARIOS, JSON.stringify(lista));

  carregarDiario();
  limparDiario();
}

function carregarDiario(){
  const tbody = document.getElementById("tabelaDiario");
  tbody.innerHTML = "";

  let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

  lista.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td><strong>${r.dataBR}</strong></td>
        <td>${r.pessoas.join("<br>")}</td>
        <td>
          <div class="row-actions">
            <button class="btn small secondary" type="button" onclick="editarRegistro('${r.dataISO}')">âœ Editar</button>
            <button class="btn small danger" type="button" onclick="apagarRegistro('${r.dataISO}')">ğŸ—‘ Apagar</button>
          </div>
        </td>
      </tr>
    `;
  });
}

function editarRegistro(dataISO){
  let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");
  const reg = lista.find(x => x.dataISO === dataISO);

  if(!reg){
    alert("Registro nÃ£o encontrado.");
    return;
  }

  // Carrega no formulÃ¡rio
  document.getElementById("dataDia").value = reg.dataISO;
  selecaoDiaria = [...reg.pessoas];

  renderChipsDiario();

  // Leva o usuÃ¡rio pro topo/form
  document.getElementById("cardPresenca").scrollIntoView({ behavior: "smooth", block: "start" });
}

function apagarRegistro(dataISO){
  if(!confirm("Deseja apagar somente este dia registrado?")) return;

  let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");
  lista = lista.filter(x => x.dataISO !== dataISO);

  localStorage.setItem(KEY_DIARIOS, JSON.stringify(lista));
  carregarDiario();

  // Se estiver com essa data carregada no formulÃ¡rio, limpa
  if(document.getElementById("dataDia").value === dataISO){
    limparDiario();
  }
}

function limparDiario(){
  document.getElementById("dataDia").value = "";
  selecaoDiaria = [];
  renderChipsDiario();
}

function apagarDiarios(){
  if(confirm("Deseja apagar todos os registros?")){
    localStorage.removeItem(KEY_DIARIOS);
    carregarDiario();
  }
}

function exportarDiarioCSV(){
  let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

  if(lista.length === 0){
    alert("NÃ£o hÃ¡ registros para exportar.");
    return;
  }

  let csv = "Data;Pessoas\n";
  lista.forEach(r => {
    csv += `${r.dataBR};"${r.pessoas.join(", ")}"\n`;
  });

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "presencas_ferroport.csv";
  link.click();
}

// Inicializa
salvarNomes();
renderChipsDiario();
carregarDiario();
</script>

</body>
</html>
