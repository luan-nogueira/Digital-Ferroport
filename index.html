<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presen√ßa di√°ria ‚Äî Contratos</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<!-- ===================== LOGIN ===================== -->
<section class="login-page" id="loginBox" style="display:none;">
  <div class="login-card">
    <div class="login-logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <h2>Acesso restrito</h2>
    <p class="muted">Entre com seu e-mail e senha para acessar o controle de presen√ßa.</p>

    <div class="grid-2">
      <div class="field">
        <label>E-mail</label>
        <input id="loginEmail" type="email" placeholder="seuemail@empresa.com" autocomplete="username">
      </div>

      <div class="field">
        <label>Senha</label>

        <div class="input-icon">
          <input id="loginSenha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">

          <button class="icon-btn" type="button"
            onclick="toggleSenha('loginSenha', this)"
            aria-label="Mostrar/ocultar senha"
            title="Mostrar/ocultar senha">

            <span class="cam-icon cam-closed">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 7a3 3 0 0 1 3-3h6l2 2h2a3 3 0 0 1 3 3v7a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7z"></path>
                <path d="M9.5 12a2.5 2.5 0 1 0 5 0a2.5 2.5 0 0 0-5 0z"></path>
                <path d="M3 3l18 18" class="stroke"></path>
              </svg>
            </span>

            <span class="cam-icon cam-open" style="display:none;">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 7a3 3 0 0 1 3-3h6l2 2h2a3 3 0 0 1 3 3v7a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7z"></path>
                <path d="M9.5 12a2.5 2.5 0 1 0 5 0a2.5 2.5 0 0 0-5 0z"></path>
              </svg>
            </span>

          </button>
        </div>
      </div>
    </div>

    <div class="actions center">
      <button class="btn" id="btnEntrar" type="button" onclick="login()">Entrar</button>
      <button class="btn secondary" type="button" onclick="esqueciSenha()">Esqueci minha senha</button>
      <button class="btn secondary small" type="button" id="btnTemaLogin" onclick="toggleTema()">üåô Tema</button>
    </div>

    <div class="login-status" id="loginStatus" style="display:none;">
      <span class="spinner"></span>
      <span>Entrando...</span>
    </div>

    <p class="muted small center" id="loginMsg"></p>
    <p class="muted tiny center">DIGITAL ‚Ä¢ EMIVE ‚Äî Tecnologia e Seguran√ßa</p>
  </div>
</section>

<!-- ===================== APP ===================== -->
<div id="appRoot" style="display:none;">

<header class="topbar no-print">
  <div class="brand">
    <div class="logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div>
      <div class="brand-title">Presen√ßa di√°ria ‚Äî Contratos</div>
      <div class="brand-subtitle" id="userBadge">Logado como: ‚Äî</div>
    </div>

    <div class="top-actions">
      <button class="btn secondary small" type="button" id="btnTema" onclick="toggleTema()">üåô Tema</button>

      <div class="field inline">
        <label>Contrato</label>
        <select id="contratoSelect">
          <option value="ferroport">Ferroport</option>
          <option value="pta-inveco">PTA INVECO</option>
        </select>
      </div>

      <span class="role-pill" id="rolePill">‚Äî</span>
      <button class="btn secondary small" type="button" onclick="logout()">Sair</button>
    </div>
  </div>
</header>

<main class="container">

  <!-- ====== PAINEL DO GESTOR ====== -->
  <section class="card">
    <div class="card-head">
      <h2>Painel do gestor</h2>
      <p class="muted">Selecione o m√™s para ver o ranking, resumo e gerar o relat√≥rio em PDF.</p>
    </div>

    <div class="grid-3">
      <div class="field">
        <label>M√™s/Ano</label>
        <input id="mesAno" type="month" />
      </div>

      <div class="field">
        <label>Resumo</label>
        <div class="kpi-wrap">
          <div class="kpi">
            <div class="kpi-label">Dias registrados</div>
            <div class="kpi-value" id="kpiDias">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Pessoas/Condutores no m√™s</div>
            <div class="kpi-value" id="kpiTecnicos">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Presen√ßas/Registros (total)</div>
            <div class="kpi-value" id="kpiPresencas">0</div>
          </div>
        </div>
      </div>

      <div class="field">
        <label>A√ß√µes</label>
        <div class="actions">
          <button class="btn" type="button" onclick="atualizarPainel()">üîÑ Atualizar</button>
          <button class="btn secondary" type="button" onclick="gerarPDF()">üìÑ Gerar PDF</button>
        </div>
        <p class="muted small">O PDF √© gerado via impress√£o do navegador (Ctrl+P).</p>
      </div>
    </div>

    <div class="split">
      <div>
        <h3 class="h3">Ranking (dias no m√™s)</h3>
        <table class="table-compact">
          <thead>
            <tr>
              <th>#</th>
              <th>T√©cnico/Condutor</th>
              <th>Dias</th>
              <th style="width:38%;">Progresso</th>
            </tr>
          </thead>
          <tbody id="tabelaRanking"></tbody>
        </table>
      </div>

      <div>
        <h3 class="h3">Registros do m√™s (para o relat√≥rio)</h3>
        <table class="table-compact">
          <thead>
            <tr>
              <th>Data</th>
              <th>Pessoas/Condutor</th>
            </tr>
          </thead>
          <tbody id="tabelaMes"></tbody>
        </table>

        <div class="ver-mais-wrap">
          <button class="btn secondary small" id="btnVerMaisMes" type="button" onclick="toggleVerMaisMes()">
            Ver mais registros
          </button>
        </div>
      </div>
    </div>

    <div class="dash">
      <div class="dash-box">
        <div class="dash-title">üìä Dias por t√©cnico/condutor (Top 10)</div>
        <canvas id="chartRanking" class="dash-canvas"></canvas>
        <p class="muted small">Mostra quem teve mais dias no m√™s selecionado.</p>
      </div>

      <div class="dash-box">
        <div class="dash-title">üìå Insights r√°pidos</div>
        <div class="insights">
          <div class="insight">
            <div class="insight-label">Maior frequ√™ncia</div>
            <div class="insight-value" id="insightTopNome">‚Äî</div>
          </div>
          <div class="insight">
            <div class="insight-label">Dias do Top 1</div>
            <div class="insight-value" id="insightTopDias">0</div>
          </div>
          <div class="insight">
            <div class="insight-label">M√©dia registros/dia</div>
            <div class="insight-value" id="insightMediaDia">0</div>
          </div>
          <div class="insight">
            <div class="insight-label">M√©dia dias/pessoa</div>
            <div class="insight-value" id="insightMediaTec">0</div>
          </div>
        </div>

        <p class="muted small">Resumo autom√°tico com base no m√™s selecionado.</p>
      </div>
    </div>
  </section>

  <!-- ====== FORMUL√ÅRIO DI√ÅRIO ====== -->
  <section class="card" id="cardPresenca">
    <div class="card-head">
      <h2 id="tituloPresenca">Presen√ßa por dia</h2>
      <p class="muted" id="subtituloPresenca">Selecione a data e marque quem esteve no contrato.</p>
    </div>

    <!-- ‚úÖ FORM PADR√ÉO -->
    <div id="formPadrao">
      <div class="grid-2">
        <div class="field">
          <label>Data</label>
          <input id="dataDia" type="date" />
        </div>

        <div class="field">
          <label>Pessoas</label>
          <div class="chips" id="chipsDiario"></div>

          <div class="add-nome">
            <input type="text" id="novoNome" placeholder="Adicionar t√©cnico (ex: Jo√£o Silva)">
            <button class="btn" type="button" onclick="adicionarNome()">+ Adicionar</button>
          </div>

          <p class="muted small">Os nomes ficam salvos no banco (tempo real).</p>
          <p class="muted small" id="permMsg" style="display:none;">Voc√™ est√° como T√©cnico: algumas a√ß√µes ficam bloqueadas.</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn" type="button" onclick="salvarDiario()">üíæ Salvar dia</button>
        <button class="btn secondary" type="button" onclick="limparDiario()">üßπ Limpar</button>
        <button class="btn danger" id="btnApagarTudo" type="button" onclick="apagarDiarios()">üóë Apagar tudo</button>
        <button class="btn" type="button" onclick="exportarDiarioCSV()">‚¨á Exportar Excel</button>
      </div>
    </div>

    <!-- ‚úÖ FORM PTA INVECO (COM ASSINATURA DESENHADA) -->
    <div id="formPTA" style="display:none;">
      <div class="grid-3">
        <div class="field">
          <label>Data</label>
          <input id="ptaData" type="date" />
        </div>

        <div class="field">
          <label>Nome do Condutor</label>
          <input id="ptaCondutor" type="text" placeholder="Ex: Alex" />
        </div>

        <div class="field">
          <label>Local da Atividade</label>
          <input id="ptaLocal" type="text" placeholder="Ex: Vast / Ferroport / GNA" />
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px;">
        <div class="field">
          <label>Km Inicial</label>
          <input id="ptaKmInicial" type="text" inputmode="decimal" placeholder="Ex: 79.754" />
        </div>

        <div class="field">
          <label>Km Final</label>
          <input id="ptaKmFinal" type="text" inputmode="decimal" placeholder="Ex: 79.779" />
        </div>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Descri√ß√£o da Atividade</label>
        <input id="ptaDescricao" type="text" placeholder="Ex: Chave deixada com Luan no fim do dia" />
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Assinatura (desenhe com o dedo)</label>

        <div class="sig-wrap">
          <canvas id="sigCanvas"></canvas>
        </div>

        <div class="sig-actions">
          <button class="btn secondary small" type="button" onclick="limparAssinatura()">üßΩ Limpar assinatura</button>
          <span class="muted small" id="sigHint">Dica: se estiver dif√≠cil no celular, vire a tela na horizontal.</span>
        </div>

        <input id="ptaAssinaturaNome" type="text" placeholder="Opcional: Nome do assinante (texto)" style="margin-top:10px;">
      </div>

      <div class="actions">
        <button class="btn" type="button" onclick="salvarDiario()">üíæ Salvar dia</button>
        <button class="btn secondary" type="button" onclick="limparDiario()">üßπ Limpar</button>
        <button class="btn danger" id="btnApagarTudoPTA" type="button" onclick="apagarDiarios()">üóë Apagar tudo</button>
        <button class="btn" type="button" onclick="exportarDiarioCSV()">‚¨á Exportar Excel</button>
      </div>
    </div>
  </section>

  <!-- ====== LISTA DE REGISTROS ====== -->
  <section class="card no-print">
    <div class="card-head">
      <h2>Registros</h2>
      <p class="muted">Se salvar a mesma data novamente, o sistema atualiza. Use ‚ÄúEditar‚Äù para carregar um registro.</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th id="thCol2">Pessoas</th>
          <th id="thCol3" style="display:none;">Km Inicial</th>
          <th id="thCol4" style="display:none;">Km Final</th>
          <th id="thCol5" style="display:none;">Local</th>
          <th id="thCol6" style="display:none;">Descri√ß√£o</th>
          <th id="thCol7" style="display:none;">Assinatura</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaDiario"></tbody>
    </table>

    <div class="ver-mais-wrap">
      <button class="btn secondary small" id="btnVerMais" type="button" onclick="toggleVerMais()">
        Ver mais registros
      </button>
    </div>
  </section>

  <footer class="footer no-print">
    DIGITAL ‚Ä¢ EMIVE ‚Ä¢ Tecnologia e Seguran√ßa
  </footer>

</main>

</div>

<!-- ====== MODAL ASSINATURA (PTA) ====== -->
<div class="modal" id="sigModal" style="display:none;">
  <div class="modal-backdrop" onclick="fecharAssinaturaModal()"></div>
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">Assinatura</div>
      <button class="btn secondary small" type="button" onclick="fecharAssinaturaModal()">Fechar</button>
    </div>
    <div class="modal-body">
      <img id="sigModalImg" alt="Assinatura" />
      <div class="muted small" id="sigModalText"></div>
    </div>
  </div>
</div>

<!-- ====== PDF (mantido) ====== -->
<section class="print-only report">
  <div class="report-head">
    <div class="report-logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div class="report-titles">
      <div class="report-title">Relat√≥rio ‚Äî <span id="reportContrato">‚Äî</span></div>
      <div class="report-subtitle" id="reportPeriodo">Per√≠odo: ‚Äî</div>
      <div class="report-subtitle" id="reportGeradoEm">Gerado em: ‚Äî</div>
    </div>
  </div>

  <div class="report-grid">
    <div class="report-box">
      <div class="box-title">Ranking ‚Äî Dias</div>
      <table class="report-table">
        <thead>
          <tr>
            <th>#</th>
            <th>T√©cnico/Condutor</th>
            <th>Dias</th>
          </tr>
        </thead>
        <tbody id="printRanking"></tbody>
      </table>
    </div>

    <div class="report-box">
      <div class="box-title">Registros do m√™s</div>
      <table class="report-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Registro</th>
          </tr>
        </thead>
        <tbody id="printMes"></tbody>
      </table>
    </div>
  </div>

  <div class="report-footer">
    DIGITAL ‚Ä¢ EMIVE ‚Äî Tecnologia e Seguran√ßa
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBzgChouE4W25XnD-vFybJrKVN9yl3R0IQ",
    authDomain: "ferroportluannogueira.firebaseapp.com",
    projectId: "ferroportluannogueira",
    storageBucket: "ferroportluannogueira.firebasestorage.app",
    messagingSenderId: "531699539518",
    appId: "1:531699539518:web:6e32a169d9110f70b9fb6f",
    measurementId: "G-61BRVCSHD7"
  };

  const ADMIN_EMAILS = ["luan.nogueira@digitaltecnologia.com.br"];

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let LISTA = [];
  let NOMES = [];
  let selecaoDiaria = [];
  let isAdmin = false;

  let mostrarTodosRegistros = false;
  const LIMITE_REGISTROS = 5;

  let mostrarTodosMes = false;
  const LIMITE_MES = 6;

  const KEY_CONTRATO = "contrato_atual";
  let contratoAtual = localStorage.getItem(KEY_CONTRATO) || "ferroport";

  let refDiarios = null;
  let refNomes = null;
  let unsubDiarios = null;
  let unsubNomes = null;

  // ===================== TEMA =====================
  const KEY_TEMA = "tema_site";
  function aplicarTema(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(KEY_TEMA, theme);

    const txt = theme === "dark" ? "‚òÄÔ∏è Tema" : "üåô Tema";
    const btn = document.getElementById("btnTema");
    const btnLogin = document.getElementById("btnTemaLogin");
    if(btn) btn.textContent = txt;
    if(btnLogin) btnLogin.textContent = txt;

    setTimeout(() => atualizarPainel(), 10);
  }
  window.toggleTema = function(){
    const atual = document.documentElement.getAttribute("data-theme") || "light";
    aplicarTema(atual === "dark" ? "light" : "dark");
  };
  window.addEventListener("DOMContentLoaded", () => {
    const salvo = localStorage.getItem(KEY_TEMA) || "light";
    aplicarTema(salvo);
  });

  // ===================== MOSTRAR/OCULTAR SENHA =====================
  window.toggleSenha = function(inputId, btn){
    const input = document.getElementById(inputId);
    if(!input || !btn) return;

    const mostrando = input.type === "text";
    input.type = mostrando ? "password" : "text";

    const closed = btn.querySelector(".cam-closed");
    const open = btn.querySelector(".cam-open");
    if(closed && open){
      closed.style.display = mostrando ? "inline-flex" : "none";
      open.style.display = mostrando ? "none" : "inline-flex";
    }
  };

  // ===================== ASSINATURA DESENHADA =====================
  let sig = {
    canvas: null,
    ctx: null,
    drawing: false,
    lastX: 0,
    lastY: 0
  };

  function setupSignatureCanvas(){
    const c = document.getElementById("sigCanvas");
    if(!c) return;

    sig.canvas = c;
    sig.ctx = c.getContext("2d", { willReadFrequently: false });

    // tamanho responsivo
    const parent = c.parentElement;
    const w = Math.max(280, parent.clientWidth);
    const h = 160;

    const dpr = window.devicePixelRatio || 1;
    c.style.width = w + "px";
    c.style.height = h + "px";
    c.width = Math.floor(w * dpr);
    c.height = Math.floor(h * dpr);

    sig.ctx.setTransform(dpr,0,0,dpr,0,0);
    sig.ctx.lineCap = "round";
    sig.ctx.lineJoin = "round";
    sig.ctx.lineWidth = 2.2;
    sig.ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--text").trim() || "#111";

    // evita scroll ao desenhar no mobile
    c.style.touchAction = "none";
  }

  function getPos(evt){
    const rect = sig.canvas.getBoundingClientRect();
    const x = (evt.clientX - rect.left);
    const y = (evt.clientY - rect.top);
    return { x, y };
  }

  function startDraw(evt){
    if(!sig.canvas) return;
    sig.drawing = true;
    const p = getPos(evt);
    sig.lastX = p.x; sig.lastY = p.y;
    sig.ctx.beginPath();
    sig.ctx.moveTo(sig.lastX, sig.lastY);
  }

  function moveDraw(evt){
    if(!sig.drawing || !sig.canvas) return;
    const p = getPos(evt);
    sig.ctx.lineTo(p.x, p.y);
    sig.ctx.stroke();
    sig.lastX = p.x; sig.lastY = p.y;
  }

  function endDraw(){
    sig.drawing = false;
  }

  function clearSignature(){
    if(!sig.canvas) return;
    const rect = sig.canvas.getBoundingClientRect();
    sig.ctx.clearRect(0, 0, rect.width, rect.height);
  }

  function signatureIsEmpty(){
    if(!sig.canvas) return true;
    const ctx = sig.ctx;
    const w = sig.canvas.width, h = sig.canvas.height;
    const pixels = ctx.getImageData(0,0,w,h).data;
    for(let i=3; i<pixels.length; i+=4){
      if(pixels[i] !== 0) return false; // alpha
    }
    return true;
  }

  function getSignatureDataURL(){
    if(!sig.canvas) return "";
    if(signatureIsEmpty()) return "";

    // export reduzido (para n√£o ficar enorme no Firestore)
    const maxW = 700;
    const rect = sig.canvas.getBoundingClientRect();
    const scale = Math.min(1, maxW / rect.width);

    const out = document.createElement("canvas");
    out.width = Math.floor(rect.width * scale);
    out.height = Math.floor(rect.height * scale);

    const octx = out.getContext("2d");
    octx.clearRect(0,0,out.width,out.height);
    octx.drawImage(sig.canvas, 0,0, out.width, out.height);

    return out.toDataURL("image/png");
  }

  window.limparAssinatura = function(){
    clearSignature();
  };

  function bindSignatureEvents(){
    const c = document.getElementById("sigCanvas");
    if(!c) return;

    // pointer events (funciona mouse + touch)
    c.addEventListener("pointerdown", (e)=>{ c.setPointerCapture(e.pointerId); startDraw(e); });
    c.addEventListener("pointermove", (e)=> moveDraw(e));
    c.addEventListener("pointerup", ()=> endDraw());
    c.addEventListener("pointercancel", ()=> endDraw());
    c.addEventListener("pointerleave", ()=> endDraw());
  }

  // modal assinatura
  window.abrirAssinaturaModal = function(dataUrl, nomeTexto){
    const modal = document.getElementById("sigModal");
    const img = document.getElementById("sigModalImg");
    const txt = document.getElementById("sigModalText");
    if(!modal || !img) return;

    img.src = dataUrl || "";
    txt.textContent = nomeTexto ? `Assinante: ${nomeTexto}` : "";
    modal.style.display = "block";
  };
  window.fecharAssinaturaModal = function(){
    const modal = document.getElementById("sigModal");
    if(modal) modal.style.display = "none";
  };

  // ===================== CONTRATO / UI =====================
  function isPTA(){ return contratoAtual === "pta-inveco"; }

  function aplicarModoContratoUI(){
    const formPadrao = document.getElementById("formPadrao");
    const formPTA = document.getElementById("formPTA");
    const titulo = document.getElementById("tituloPresenca");
    const subtitulo = document.getElementById("subtituloPresenca");

    const thCol2 = document.getElementById("thCol2");
    const thCol3 = document.getElementById("thCol3");
    const thCol4 = document.getElementById("thCol4");
    const thCol5 = document.getElementById("thCol5");
    const thCol6 = document.getElementById("thCol6");
    const thCol7 = document.getElementById("thCol7");

    if(isPTA()){
      formPadrao.style.display = "none";
      formPTA.style.display = "block";
      titulo.textContent = "Controle de Uso ‚Äî PTA INVECO";
      subtitulo.textContent = "Preencha os dados do ve√≠culo por dia (condutor, km, local, descri√ß√£o e assinatura).";

      thCol2.textContent = "Condutor";
      thCol3.style.display = "";
      thCol4.style.display = "";
      thCol5.style.display = "";
      thCol6.style.display = "";
      thCol7.style.display = "";

      // prepara assinatura
      setupSignatureCanvas();
    } else {
      formPadrao.style.display = "block";
      formPTA.style.display = "none";
      titulo.textContent = "Presen√ßa por dia";
      subtitulo.textContent = "Selecione a data e marque quem esteve no contrato.";

      thCol2.textContent = "Pessoas";
      thCol3.style.display = "none";
      thCol4.style.display = "none";
      thCol5.style.display = "none";
      thCol6.style.display = "none";
      thCol7.style.display = "none";
    }
  }

  /* ===================== CHART ===================== */
  function cssVar(name, fallback){
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    return v || fallback;
  }
  function fitCanvasToCSS(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const cssW = rect.width || 600;
    const cssH = rect.height || 280;

    canvas.width  = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);

    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return { ctx, w: cssW, h: cssH };
  }
  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, h/2, w/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }
  function drawBarChart(canvasId, items){
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;

    const rows = (items && items.length) ? items.length : 1;
    const autoH = Math.max(260, rows * 34 + 50);
    canvas.style.height = autoH + "px";

    const { ctx, w, h } = fitCanvasToCSS(canvas);
    ctx.clearRect(0,0,w,h);

    const muted = cssVar("--muted", "#6B7280");
    const textColor = cssVar("--text", "#1E2328");
    const red = cssVar("--digital-red", "#CB3344");
    const barBg = cssVar("--bar-bg", "#E6E8EE");
    const insideText = cssVar("--text-invert", "#ffffff");

    if(!items || items.length === 0){
      ctx.fillStyle = muted;
      ctx.font = "14px Arial";
      ctx.textAlign = "center";
      ctx.fillText("Sem dados para este m√™s.", w/2, h/2);
      return;
    }

    const padL = 12, padR = 12, padT = 14, padB = 14;
    const innerW = w - padL - padR;
    const innerH = h - padT - padB;

    const maxV = Math.max(...items.map(x=>x.value), 1);
    const rowH = Math.max(30, Math.floor(innerH / items.length));
    const barH = Math.max(14, rowH - 14);
    const labelW = Math.max(110, Math.min(190, Math.floor(innerW * 0.42)));

    ctx.font = "12px Arial";
    ctx.textBaseline = "middle";

    items.forEach((it, i) => {
      const y = padT + i*rowH + rowH/2;

      ctx.fillStyle = textColor;
      ctx.textAlign = "left";
      const maxChars = (w < 420) ? 18 : 26;
      const label = it.label.length > maxChars ? it.label.slice(0,maxChars) + "‚Ä¶" : it.label;
      ctx.fillText(label, padL, y);

      const barX = padL + labelW;
      const barMaxW = Math.max(120, innerW - labelW - 20);
      const barW = (it.value / maxV) * barMaxW;

      ctx.fillStyle = barBg;
      roundRect(ctx, barX, y - barH/2, barMaxW, barH, 999);
      ctx.fill();

      ctx.fillStyle = red;
      roundRect(ctx, barX, y - barH/2, Math.max(6, barW), barH, 999);
      ctx.fill();

      const valueText = String(it.value);
      const textW = ctx.measureText(valueText).width;

      if(barW >= textW + 16){
        ctx.fillStyle = insideText;
        ctx.textAlign = "right";
        ctx.fillText(valueText, barX + barW - 8, y);
      } else {
        ctx.fillStyle = muted;
        ctx.textAlign = "left";
        ctx.fillText(valueText, barX + barW + 8, y);
      }
    });
  }

  /* ===================== FIREBASE / DADOS ===================== */
  function setRefsContrato(){
    refDiarios = collection(db, "contratos", contratoAtual, "diarios");
    refNomes   = collection(db, "contratos", contratoAtual, "nomes");
  }

  window.login = async function(){
    const email = document.getElementById("loginEmail").value.trim();
    const senha = document.getElementById("loginSenha").value.trim();
    const msg = document.getElementById("loginMsg");
    const status = document.getElementById("loginStatus");
    const btn = document.getElementById("btnEntrar");

    msg.textContent = "";
    status.style.display = "flex";
    btn.disabled = true;

    try{
      await signInWithEmailAndPassword(auth, email, senha);
    }catch(e){
      msg.textContent = "Falha no login: " + (e?.code || e?.message || e);
      status.style.display = "none";
      btn.disabled = false;
    }
  };

  window.esqueciSenha = async function(){
    const email = document.getElementById("loginEmail").value.trim();
    const msg = document.getElementById("loginMsg");
    msg.textContent = "";

    if(!email){
      msg.textContent = "Digite seu e-mail para receber o link de redefini√ß√£o.";
      return;
    }

    try{
      await sendPasswordResetEmail(auth, email);
      msg.textContent = "Pronto! Enviamos um e-mail para redefinir sua senha.";
    }catch(e){
      msg.textContent = "N√£o foi poss√≠vel enviar: " + (e?.code || e?.message || e);
    }
  };

  window.logout = async function(){
    await signOut(auth);
  };

  function mostrarApp(logado){
    document.getElementById("loginBox").style.display = logado ? "none" : "flex";
    document.getElementById("appRoot").style.display = logado ? "block" : "none";
  }

  function aplicarPermissoesUI(){
    const pill = document.getElementById("rolePill");
    const permMsg = document.getElementById("permMsg");
    const btnApagarTudo = document.getElementById("btnApagarTudo");
    const btnApagarTudoPTA = document.getElementById("btnApagarTudoPTA");

    pill.textContent = isAdmin ? "Gestor" : "T√©cnico";
    pill.classList.toggle("admin", isAdmin);

    if(btnApagarTudo) btnApagarTudo.style.display = isAdmin ? "inline-block" : "none";
    if(btnApagarTudoPTA) btnApagarTudoPTA.style.display = isAdmin ? "inline-block" : "none";
    if(permMsg) permMsg.style.display = isAdmin ? "none" : "block";
  }

  function formatarDataBR(dataISO){
    const [y,m,d] = dataISO.split("-");
    return `${d}/${m}/${y}`;
  }
  function hojeISO(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function agoraBR(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function getMesAnoSelecionado(){
    const v = document.getElementById("mesAno").value;
    if(!v) return null;
    const [y,m] = v.split("-");
    return { y, m };
  }
  function idSeguro(str){
    return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"").slice(0,80);
  }
  function nomeContratoBonito(slug){
    return ({
      "ferroport":"Ferroport",
      "pta-inveco":"PTA INVECO"
    }[slug] || slug);
  }

  function desligarRealtime(){
    if(typeof unsubDiarios === "function") unsubDiarios();
    if(typeof unsubNomes === "function") unsubNomes();
  }

  function ligarRealtime(){
    desligarRealtime();

    unsubDiarios = onSnapshot(refDiarios, (snap) => {
      LISTA = snap.docs.map(d => d.data()).sort((a,b)=> (a.dataISO||"").localeCompare(b.dataISO||""));
      carregarDiario();
      atualizarPainel();
    });

    unsubNomes = onSnapshot(refNomes, (snap) => {
      NOMES = snap.docs.map(d => d.data().nome).sort((a,b) => a.localeCompare(b, "pt-BR"));
      renderChipsDiario();
    });
  }

  function setContrato(novo){
    contratoAtual = novo;
    localStorage.setItem("contrato_atual", contratoAtual);
    setRefsContrato();
    ligarRealtime();

    document.getElementById("reportContrato").textContent = nomeContratoBonito(contratoAtual);

    aplicarModoContratoUI();
    limparDiario(true);

    mostrarTodosMes = false;
    atualizarPainel();
  }

  window.renderChipsDiario = function(){
    const wrap = document.getElementById("chipsDiario");
    if(!wrap) return;
    wrap.innerHTML = "";

    NOMES.forEach(nome => {
      const box = document.createElement("div");
      box.className = "chip-box";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (selecaoDiaria.includes(nome) ? " active" : "");
      btn.innerText = nome;

      btn.onclick = () => {
        selecaoDiaria = selecaoDiaria.includes(nome)
          ? selecaoDiaria.filter(n => n !== nome)
          : [...selecaoDiaria, nome];
        renderChipsDiario();
      };

      box.appendChild(btn);
      wrap.appendChild(box);
    });
  };

  window.adicionarNome = async function(){
    const input = document.getElementById("novoNome");
    const nome = (input?.value || "").trim();
    if(!nome) return alert("Digite um nome.");

    const existe = NOMES.some(n => n.toLowerCase() === nome.toLowerCase());
    if(existe) return alert("Esse nome j√° existe.");

    await setDoc(doc(db, "contratos", contratoAtual, "nomes", idSeguro(nome)), { nome });
    input.value = "";
  };

  window.salvarDiario = async function(){
    if(isPTA()){
      const data = document.getElementById("ptaData").value;
      const condutor = document.getElementById("ptaCondutor").value.trim();
      const kmInicial = document.getElementById("ptaKmInicial").value.trim();
      const kmFinal = document.getElementById("ptaKmFinal").value.trim();
      const local = document.getElementById("ptaLocal").value.trim();
      const descricao = document.getElementById("ptaDescricao").value.trim();
      const assinaturaNome = document.getElementById("ptaAssinaturaNome").value.trim();
      const assinaturaImg = getSignatureDataURL();

      if(!data) return alert("Selecione a data.");
      if(!condutor) return alert("Informe o nome do condutor.");
      if(!assinaturaImg) return alert("Desenhe a assinatura antes de salvar.");

      const item = {
        tipo: "pta",
        dataISO: data,
        dataBR: formatarDataBR(data),
        condutor,
        kmInicial,
        kmFinal,
        local,
        descricao,
        assinaturaNome,
        assinaturaImg
      };

      await setDoc(doc(db, "contratos", contratoAtual, "diarios", data), item);
      limparDiario();
      return;
    }

    const data = document.getElementById("dataDia").value;
    if(!data) return alert("Selecione a data.");
    if(selecaoDiaria.length === 0) return alert("Selecione pelo menos uma pessoa.");

    const item = { tipo:"presenca", dataISO: data, dataBR: formatarDataBR(data), pessoas: [...selecaoDiaria] };
    await setDoc(doc(db, "contratos", contratoAtual, "diarios", data), item);
    limparDiario();
  };

  window.limparDiario = function(){
    if(isPTA()){
      document.getElementById("ptaData").value = hojeISO();
      document.getElementById("ptaCondutor").value = "";
      document.getElementById("ptaKmInicial").value = "";
      document.getElementById("ptaKmFinal").value = "";
      document.getElementById("ptaLocal").value = "";
      document.getElementById("ptaDescricao").value = "";
      document.getElementById("ptaAssinaturaNome").value = "";
      clearSignature();
      return;
    }

    document.getElementById("dataDia").value = hojeISO();
    selecaoDiaria = [];
    renderChipsDiario();
    document.getElementById("novoNome").value = "";
  };

  window.apagarDiarios = async function(){
    if(!isAdmin) return alert("Somente gestor pode apagar tudo.");
    if(!confirm("Deseja apagar TODOS os registros deste contrato?")) return;

    const snap = await getDocs(refDiarios);
    for(const d of snap.docs) await deleteDoc(d.ref);
  };

  window.exportarDiarioCSV = function(){
    if(LISTA.length === 0) return alert("N√£o h√° registros para exportar.");
    const ordenado = [...LISTA].sort((a,b)=> (a.dataISO||"").localeCompare(b.dataISO||""));

    if(isPTA()){
      let csv = "Contrato;Data;Nome do Condutor;Km Inicial;Km Final;Local da Atividade;Descri√ß√£o da Atividade;Assinatura (texto)\n";
      ordenado.forEach(r => {
        const desc = (r.descricao || "").replaceAll('"','""');
        csv += `${nomeContratoBonito(contratoAtual)};${r.dataBR || ""};${r.condutor || ""};${r.kmInicial || ""};${r.kmFinal || ""};${r.local || ""};"${desc}";${r.assinaturaNome || ""}\n`;
      });

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `controle_uso_${contratoAtual}.csv`;
      link.click();
      return;
    }

    let csv = "Contrato;Data;Pessoas\n";
    ordenado.forEach(r => {
      csv += `${nomeContratoBonito(contratoAtual)};${r.dataBR};"${(r.pessoas || []).join(", ")}"\n`;
    });

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `presencas_${contratoAtual}.csv`;
    link.click();
  };

  function atualizarBotaoVerMais(total){
    const btn = document.getElementById("btnVerMais");
    if(!btn) return;
    if(total <= LIMITE_REGISTROS){ btn.style.display="none"; return; }
    btn.style.display="inline-block";
    btn.innerText = mostrarTodosRegistros ? "Ver menos" : "Ver mais registros";
  }
  window.toggleVerMais = function(){
    mostrarTodosRegistros = !mostrarTodosRegistros;
    carregarDiario();
  };

  function carregarDiario(){
    aplicarModoContratoUI();

    const tbody = document.getElementById("tabelaDiario");
    tbody.innerHTML = "";

    const lista = [...LISTA].sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||""));
    const exibida = mostrarTodosRegistros ? lista : lista.slice(0, LIMITE_REGISTROS);

    exibida.forEach(r => {
      if(isPTA()){
        const temAss = !!r.assinaturaImg;
        tbody.innerHTML += `
          <tr>
            <td><strong>${r.dataBR || ""}</strong></td>
            <td>${r.condutor || ""}</td>
            <td>${r.kmInicial || ""}</td>
            <td>${r.kmFinal || ""}</td>
            <td>${r.local || ""}</td>
            <td>${r.descricao || ""}</td>
            <td>
              ${temAss
                ? `<button class="btn secondary small" type="button"
                    onclick="abrirAssinaturaModal('${r.assinaturaImg}', '${(r.assinaturaNome||"").replaceAll("'","\\'")}')">
                    Ver assinatura
                   </button>`
                : `<span class="muted small">‚Äî</span>`
              }
            </td>
            <td>
              <div class="row-actions">
                <button class="btn small secondary" type="button" onclick="editarRegistro('${r.dataISO}')">‚úè Editar</button>
                <button class="btn small danger" type="button" onclick="apagarRegistro('${r.dataISO}')" ${isAdmin ? "" : "disabled"}>üóë Apagar</button>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML += `
        <tr>
          <td><strong>${r.dataBR}</strong></td>
          <td>${(r.pessoas || []).join("<br>")}</td>
          <td>
            <div class="row-actions">
              <button class="btn small secondary" type="button" onclick="editarRegistro('${r.dataISO}')">‚úè Editar</button>
              <button class="btn small danger" type="button" onclick="apagarRegistro('${r.dataISO}')" ${isAdmin ? "" : "disabled"}>üóë Apagar</button>
            </div>
          </td>
        </tr>
      `;
    });

    atualizarBotaoVerMais(lista.length);
  }

  window.editarRegistro = function(dataISO){
    const reg = LISTA.find(x => x.dataISO === dataISO);
    if(!reg) return alert("Registro n√£o encontrado.");

    if(isPTA()){
      document.getElementById("ptaData").value = reg.dataISO || hojeISO();
      document.getElementById("ptaCondutor").value = reg.condutor || "";
      document.getElementById("ptaKmInicial").value = reg.kmInicial || "";
      document.getElementById("ptaKmFinal").value = reg.kmFinal || "";
      document.getElementById("ptaLocal").value = reg.local || "";
      document.getElementById("ptaDescricao").value = reg.descricao || "";
      document.getElementById("ptaAssinaturaNome").value = reg.assinaturaNome || "";

      setupSignatureCanvas();
      clearSignature();
      // desenha assinatura existente no canvas (se tiver)
      if(reg.assinaturaImg){
        const img = new Image();
        img.onload = () => {
          const rect = sig.canvas.getBoundingClientRect();
          sig.ctx.drawImage(img, 0,0, rect.width, rect.height);
        };
        img.src = reg.assinaturaImg;
      }
    } else {
      document.getElementById("dataDia").value = reg.dataISO || hojeISO();
      selecaoDiaria = [...(reg.pessoas || [])];
      renderChipsDiario();
    }

    document.getElementById("cardPresenca").scrollIntoView({ behavior: "smooth", block: "start" });
  };

  window.apagarRegistro = async function(dataISO){
    if(!isAdmin) return alert("Somente gestor pode apagar registros.");
    if(!confirm("Deseja apagar somente este dia registrado?")) return;
    await deleteDoc(doc(db, "contratos", contratoAtual, "diarios", dataISO));
    limparDiario();
  };

  // painel (mantido do seu)
  window.atualizarPainel = function(){
    const sel = getMesAnoSelecionado();
    if(!sel){
      const hoje = new Date();
      const pad = (n)=> String(n).padStart(2,"0");
      document.getElementById("mesAno").value = `${hoje.getFullYear()}-${pad(hoje.getMonth()+1)}`;
      return atualizarPainel();
    }

    const prefixo = `${sel.y}-${sel.m}`;
    const registrosMes = LISTA.filter(r => (r.dataISO || "").startsWith(prefixo));

    const diasRegistrados = registrosMes.length;
    const totalPresencas = isPTA()
      ? diasRegistrados
      : registrosMes.reduce((acc,r)=> acc + ((r.pessoas||[]).length), 0);

    document.getElementById("kpiDias").innerText = diasRegistrados;
    document.getElementById("kpiPresencas").innerText = totalPresencas;

    const contagem = new Map();
    if(isPTA()){
      registrosMes.forEach(r => {
        const c = (r.condutor || "").trim();
        if(!c) return;
        contagem.set(c, (contagem.get(c)||0) + 1);
      });
    } else {
      registrosMes.forEach(r => Array.from(new Set(r.pessoas||[])).forEach(p => contagem.set(p,(contagem.get(p)||0)+1)));
    }
    document.getElementById("kpiTecnicos").innerText = contagem.size;

    const ranking = Array.from(contagem.entries()).map(([nome,dias])=>({nome,dias}))
      .sort((a,b)=> b.dias-a.dias || a.nome.localeCompare(b.nome,"pt-BR"));
    const maxDias = ranking.length ? Math.max(...ranking.map(x=>x.dias)) : 0;

    document.getElementById("tabelaRanking").innerHTML = ranking.length
      ? ranking.map((x,i)=>`
          <tr>
            <td>${i+1}</td>
            <td>${x.nome}</td>
            <td><strong>${x.dias}</strong></td>
            <td><div class="bar"><div class="bar-fill" style="width:${maxDias ? (x.dias/maxDias*100).toFixed(0) : 0}%;"></div></div></td>
          </tr>
        `).join("")
      : `<tr><td colspan="4" class="muted">Sem registros neste m√™s.</td></tr>`;

    const ordenados = [...registrosMes].sort((a,b)=> (a.dataISO||"").localeCompare(b.dataISO||""));
    const exibidaMes = mostrarTodosMes ? ordenados : ordenados.slice(0, LIMITE_MES);

    document.getElementById("tabelaMes").innerHTML = exibidaMes.length
      ? exibidaMes.map(r=>`
          <tr>
            <td><strong>${r.dataBR || ""}</strong></td>
            <td>${isPTA() ? (r.condutor || "") : (r.pessoas||[]).join("<br>")}</td>
          </tr>
        `).join("")
      : `<tr><td colspan="2" class="muted">Sem registros neste m√™s.</td></tr>`;

    // gr√°fico
    const top10 = ranking.slice(0, 10).map(x => ({ label: x.nome, value: x.dias }));
    drawBarChart("chartRanking", top10);

    // insights
    const topNome = ranking[0]?.nome || "‚Äî";
    const topDias = ranking[0]?.dias || 0;
    const mediaDia = diasRegistrados ? (totalPresencas / diasRegistrados) : 0;
    const mediaTec = contagem.size ? (diasRegistrados / contagem.size) : 0;

    document.getElementById("insightTopNome").textContent = topNome;
    document.getElementById("insightTopDias").textContent = String(topDias);
    document.getElementById("insightMediaDia").textContent = mediaDia.toFixed(1);
    document.getElementById("insightMediaTec").textContent = mediaTec.toFixed(1);

    // print
    document.getElementById("reportPeriodo").innerText = `Per√≠odo: ${sel.m}/${sel.y}`;
    document.getElementById("reportGeradoEm").innerText = `Gerado em: ${agoraBR()}`;
    document.getElementById("reportContrato").textContent = nomeContratoBonito(contratoAtual);
  };

  window.gerarPDF = function(){
    atualizarPainel();
    setTimeout(()=> window.print(), 50);
  };

  function initUI(){
    const selContrato = document.getElementById("contratoSelect");
    selContrato.value = contratoAtual;
    selContrato.addEventListener("change", ()=> setContrato(selContrato.value));

    document.getElementById("dataDia").value = hojeISO();
    document.getElementById("ptaData").value = hojeISO();

    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    document.getElementById("mesAno").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    document.getElementById("mesAno").addEventListener("change", atualizarPainel);

    aplicarModoContratoUI();

    // assinatura
    setupSignatureCanvas();
    bindSignatureEvents();

    window.addEventListener("resize", () => {
      // reconfigura assinatura (mant√©m melhor no mobile)
      if(isPTA()){
        const img = getSignatureDataURL(); // salva "snap"
        setupSignatureCanvas();
        clearSignature();
        if(img){
          const im = new Image();
          im.onload = () => {
            const rect = sig.canvas.getBoundingClientRect();
            sig.ctx.drawImage(im, 0,0, rect.width, rect.height);
          };
          im.src = img;
        }
      }
      atualizarPainel();
    });
  }

  onAuthStateChanged(auth, (user) => {
    if(!user){
      mostrarApp(false);
      desligarRealtime();
      document.getElementById("loginStatus").style.display = "none";
      const btn = document.getElementById("btnEntrar");
      if(btn) btn.disabled = false;
      return;
    }

    const email = (user.email || "").toLowerCase();
    isAdmin = ADMIN_EMAILS.map(x=>String(x).toLowerCase()).includes(email);

    document.getElementById("userBadge").textContent = `Logado como: ${user.email || "‚Äî"}`;
    aplicarPermissoesUI();
    mostrarApp(true);

    setRefsContrato();
    ligarRealtime();
    initUI();
    atualizarPainel();
  });

  setRefsContrato();
</script>

</body>
</html>
