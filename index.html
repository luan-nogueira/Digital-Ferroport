<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PresenÃ§a diÃ¡ria â€” Ferroport</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header class="topbar no-print">
  <div class="brand">
    <div class="logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div>
      <div class="brand-title">PresenÃ§a diÃ¡ria â€” Ferroport</div>
      <div class="brand-subtitle">Controle de tÃ©cnicos no contrato</div>
    </div>
  </div>
</header>

<main class="container">

  <!-- ====== RELATÃ“RIO / PAINEL DO GESTOR ====== -->
  <section class="card">
    <div class="card-head">
      <h2>Painel do gestor</h2>
      <p class="muted">Selecione o mÃªs para ver o ranking e gerar o relatÃ³rio em PDF.</p>
    </div>

    <div class="grid-3">
      <div class="field">
        <label>MÃªs/Ano</label>
        <input id="mesAno" type="month" />
      </div>

      <div class="field">
        <label>Resumo</label>
        <div class="kpi-wrap">
          <div class="kpi">
            <div class="kpi-label">Dias registrados</div>
            <div class="kpi-value" id="kpiDias">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">TÃ©cnicos no mÃªs</div>
            <div class="kpi-value" id="kpiTecnicos">0</div>
          </div>
        </div>
      </div>

      <div class="field">
        <label>AÃ§Ãµes</label>
        <div class="actions">
          <button class="btn" type="button" onclick="atualizarPainel()">ğŸ”„ Atualizar</button>
          <button class="btn secondary" type="button" onclick="gerarPDF()">ğŸ“„ Gerar PDF</button>
        </div>
        <p class="muted small">O PDF Ã© gerado via impressÃ£o do navegador (Ctrl+P).</p>
      </div>
    </div>

    <div class="split">
      <div>
        <h3 class="h3">Ranking (dias trabalhados no mÃªs)</h3>
        <table class="table-compact">
          <thead>
            <tr>
              <th>#</th>
              <th>TÃ©cnico</th>
              <th>Dias</th>
            </tr>
          </thead>
          <tbody id="tabelaRanking"></tbody>
          <div class="ver-mais-wrap">
  <button class="btn secondary small" id="btnVerMaisRanking" type="button" onclick="toggleVerMaisRanking()">
    Ver mais ranking
  </button>
</div>
        </table>

        <!-- âœ… VER MAIS RANKING -->
        <div class="ver-mais-wrap">
          <button class="btn secondary small" id="btnVerMaisRanking" type="button" onclick="toggleVerMaisRanking()">Ver mais ranking</button>
        </div>
      </div>

      <div>
        <h3 class="h3">Registros do mÃªs (para o relatÃ³rio)</h3>
        <table class="table-compact">
          <thead>
            <tr>
              <th>Data</th>
              <th>Pessoas</th>
            </tr>
          </thead>
          <tbody id="tabelaMes"></tbody>
          <div class="ver-mais-wrap">
  <button class="btn secondary small" id="btnVerMaisMes" type="button" onclick="toggleVerMaisMes()">
    Ver mais registros do mÃªs
  </button>
</div>
        </table>

        <!-- âœ… VER MAIS REGISTROS DO MÃŠS -->
        <div class="ver-mais-wrap">
          <button class="btn secondary small" id="btnVerMaisMes" type="button" onclick="toggleVerMaisMes()">Ver mais registros do mÃªs</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== FORMULÃRIO DIÃRIO ====== -->
  <section class="card" id="cardPresenca">
    <div class="card-head">
      <h2>PresenÃ§a por dia</h2>
      <p class="muted">Selecione a data e marque quem esteve no contrato.</p>
    </div>

    <div class="grid-2">
      <div class="field">
        <label>Data</label>
        <input id="dataDia" type="date" />
      </div>

      <div class="field">
        <label>Pessoas</label>
        <div class="chips" id="chipsDiario"></div>

        <div class="add-nome">
          <input type="text" id="novoNome" placeholder="Adicionar tÃ©cnico (ex: JoÃ£o Silva)">
          <button class="btn" type="button" onclick="adicionarNome()">+ Adicionar</button>
        </div>

        <p class="muted small">Os nomes ficam salvos no navegador.</p>
      </div>
    </div>

    <div class="actions">
      <button class="btn" type="button" onclick="salvarDiario()">ğŸ’¾ Salvar dia</button>
      <button class="btn secondary" type="button" onclick="limparDiario()">ğŸ§¹ Limpar</button>
      <button class="btn danger" type="button" onclick="apagarDiarios()">ğŸ—‘ Apagar tudo</button>
      <button class="btn" type="button" onclick="exportarDiarioCSV()">â¬‡ Exportar Excel</button>
    </div>
  </section>

  <!-- ====== LISTA DE REGISTROS ====== -->
  <section class="card no-print">
    <div class="card-head">
      <h2>PresenÃ§as registradas</h2>
      <p class="muted">Se salvar a mesma data novamente, o sistema atualiza. Use â€œEditarâ€ para carregar um registro.</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Pessoas</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="tabelaDiario"></tbody>
    </table>

    <!-- âœ… VER MAIS / VER MENOS -->
    <div class="ver-mais-wrap">
      <button class="btn secondary small" id="btnVerMais" type="button" onclick="toggleVerMais()">Ver mais registros</button>
    </div>
  </section>

  <footer class="footer no-print">
    DIGITAL â€¢ EMIVE â€¢ Tecnologia e SeguranÃ§a
  </footer>

</main>

<!-- ====== CABEÃ‡ALHO DO PDF (SÃ“ APARECE NA IMPRESSÃƒO) ====== -->
<section class="print-only report">
  <div class="report-head">
    <div class="report-logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div class="report-titles">
      <div class="report-title">RelatÃ³rio de PresenÃ§a â€” Ferroport</div>
      <div class="report-subtitle" id="reportPeriodo">PerÃ­odo: â€”</div>
      <div class="report-subtitle" id="reportGeradoEm">Gerado em: â€”</div>
    </div>
  </div>

  <div class="report-grid">
    <div class="report-box">
      <div class="box-title">Ranking â€” Dias trabalhados</div>
      <table class="report-table">
        <thead>
          <tr>
            <th>#</th>
            <th>TÃ©cnico</th>
            <th>Dias</th>
          </tr>
        </thead>
        <tbody id="printRanking"></tbody>
      </table>
    </div>

    <div class="report-box">
      <div class="box-title">Registros do mÃªs</div>
      <table class="report-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Pessoas</th>
          </tr>
        </thead>
        <tbody id="printMes"></tbody>
      </table>
    </div>
  </div>

  <div class="report-footer">
    DIGITAL â€¢ EMIVE â€” Tecnologia e SeguranÃ§a
  </div>
</section>

<script>
/* ===================== DADOS ===================== */
const KEY_DIARIOS = "presencas_diarias";
const KEY_NOMES = "nomes_tecnicos";

const NOMES_PADRAO = ["Luan Nogueira", "Lucas Gregorio", "Phillipe Carvalho"];
let NOMES = JSON.parse(localStorage.getItem(KEY_NOMES)) || [...NOMES_PADRAO];
let selecaoDiaria = [];
  // âœ… VER MAIS (LISTA GERAL)
let mostrarTodosRegistros = false;
const LIMITE_REGISTROS = 5;

// âœ… VER MAIS (PAINEL DO GESTOR)
let mostrarRankingCompleto = false;
let mostrarMesCompleto = false;
const LIMITE_RANKING = 8;
const LIMITE_MES = 10;


/* âœ… VER MAIS / VER MENOS (LISTA GERAL) */
let mostrarTodosRegistros = false;
const LIMITE_REGISTROS = 5;

/* âœ… VER MAIS (PAINEL) */
let mostrarRankingCompleto = false;
let mostrarMesCompleto = false;
const LIMITE_RANKING = 8;
const LIMITE_MES = 10;

/* ===================== UTIL ===================== */
function salvarNomes(){
  localStorage.setItem(KEY_NOMES, JSON.stringify(NOMES));
}
function formatarDataBR(dataISO){
  const [y,m,d] = dataISO.split("-");
  return `${d}/${m}/${y}`;
}
function hojeISO(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function agoraBR(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function getLista(){
  return JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");
}
function setLista(lista){
  localStorage.setItem(KEY_DIARIOS, JSON.stringify(lista));
}
function getMesAnoSelecionado(){
  const v = document.getElementById("mesAno").value;
  if(!v) return null;
  const [y,m] = v.split("-");
  return { y, m };
}

/* ===================== CHIPS ===================== */
function renderChipsDiario(){
  const wrap = document.getElementById("chipsDiario");
  wrap.innerHTML = "";

  NOMES.forEach(nome => {
    const box = document.createElement("div");
    box.className = "chip-box";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "chip" + (selecaoDiaria.includes(nome) ? " active" : "");
    btn.innerText = nome;

    btn.onclick = () => {
      if (selecaoDiaria.includes(nome)) {
        selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
      } else {
        selecaoDiaria.push(nome);
      }
      renderChipsDiario();
    };

    const remover = document.createElement("span");
    remover.className = "remove";
    remover.title = "Excluir nome";
    remover.innerText = "âœ–";

    remover.onclick = (e) => {
      e.stopPropagation();
      excluirNome(nome);
    };

    box.appendChild(btn);
    box.appendChild(remover);
    wrap.appendChild(box);
  });
}

function adicionarNome(){
  const input = document.getElementById("novoNome");
  const nome = input.value.trim();

  if(!nome){
    alert("Digite um nome.");
    return;
  }

  const existe = NOMES.some(n => n.toLowerCase() === nome.toLowerCase());
  if(existe){
    alert("Esse nome jÃ¡ existe.");
    return;
  }

  NOMES.push(nome);
  NOMES.sort((a,b) => a.localeCompare(b, "pt-BR"));
  salvarNomes();

  input.value = "";
  renderChipsDiario();
}

function excluirNome(nome){
  if(!confirm(`Deseja excluir "${nome}"?`)) return;

  NOMES = NOMES.filter(n => n !== nome);
  selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
  salvarNomes();
  renderChipsDiario();
}

/* ===================== CRUD DIÃRIO ===================== */
function salvarDiario(){
  const data = document.getElementById("dataDia").value;

  if(!data) return alert("Selecione a data.");
  if(selecaoDiaria.length === 0) return alert("Selecione pelo menos uma pessoa.");

  const item = {
    dataISO: data,
    dataBR: formatarDataBR(data),
    pessoas: [...selecaoDiaria]
  };

  let lista = getLista();
  const idx = lista.findIndex(x => x.dataISO === data);
  if(idx >= 0) lista[idx] = item;
  else lista.push(item);

  lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO));
  setLista(lista);

  carregarDiario();
  atualizarPainel();
  limparDiario();
}

function carregarDiario(){
  const tbody = document.getElementById("tabelaDiario");
  tbody.innerHTML = "";

  let lista = getLista().sort((a,b) => b.dataISO.localeCompare(a.dataISO));
  const listaExibida = mostrarTodosRegistros ? lista : lista.slice(0, LIMITE_REGISTROS);

  listaExibida.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td><strong>${r.dataBR}</strong></td>
        <td>${r.pessoas.join("<br>")}</td>
        <td>
          <div class="row-actions">
            <button class="btn small secondary" type="button" onclick="editarRegistro('${r.dataISO}')">âœ Editar</button>
            <button class="btn small danger" type="button" onclick="apagarRegistro('${r.dataISO}')">ğŸ—‘ Apagar</button>
          </div>
        </td>
      </tr>
    `;
  });

  const btn = document.getElementById("btnVerMais");
  if(lista.length <= LIMITE_REGISTROS){
    btn.style.display = "none";
  }else{
    btn.style.display = "inline-block";
    btn.innerText = mostrarTodosRegistros ? "Ver menos" : "Ver mais registros";
  }
}

function toggleVerMais(){
  mostrarTodosRegistros = !mostrarTodosRegistros;
  carregarDiario();
}

function editarRegistro(dataISO){
  let lista = getLista();
  const reg = lista.find(x => x.dataISO === dataISO);
  if(!reg) return alert("Registro nÃ£o encontrado.");

  document.getElementById("dataDia").value = reg.dataISO;
  selecaoDiaria = [...reg.pessoas];
  renderChipsDiario();

  document.getElementById("cardPresenca").scrollIntoView({ behavior: "smooth", block: "start" });
}

function apagarRegistro(dataISO){
  if(!confirm("Deseja apagar somente este dia registrado?")) return;

  let lista = getLista();
  lista = lista.filter(x => x.dataISO !== dataISO);
  setLista(lista);

  carregarDiario();
  atualizarPainel();

  if(document.getElementById("dataDia").value === dataISO){
    limparDiario();
  }
}

function limparDiario(){
  document.getElementById("dataDia").value = "";
  selecaoDiaria = [];
  renderChipsDiario();
}

function apagarDiarios(){
  if(confirm("Deseja apagar todos os registros?")){
    localStorage.removeItem(KEY_DIARIOS);
    carregarDiario();
    atualizarPainel();
  }
}

function exportarDiarioCSV(){
  let lista = getLista();
  if(lista.length === 0){
    alert("NÃ£o hÃ¡ registros para exportar.");
    return;
  }

  let csv = "Data;Pessoas\n";
  lista.forEach(r => {
    csv += `${r.dataBR};"${r.pessoas.join(", ")}"\n`;
  });

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "presencas_ferroport.csv";
  link.click();
}

/* ===================== PAINEL DO GESTOR ===================== */
function atualizarPainel(){
  const sel = getMesAnoSelecionado();
  const lista = getLista();

  if(!sel){
    const hoje = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    document.getElementById("mesAno").value = `${hoje.getFullYear()}-${pad(hoje.getMonth()+1)}`;
    return atualizarPainel();
  }

  const prefixo = `${sel.y}-${sel.m}`;
  const registrosMes = lista.filter(r => r.dataISO.startsWith(prefixo));

  document.getElementById("kpiDias").innerText = registrosMes.length;

  const contagem = new Map();
  registrosMes.forEach(r => {
    const unicos = Array.from(new Set(r.pessoas));
    unicos.forEach(p => contagem.set(p, (contagem.get(p) || 0) + 1));
  });

  document.getElementById("kpiTecnicos").innerText = contagem.size;

  const ranking = Array.from(contagem.entries())
    .map(([nome, dias]) => ({ nome, dias }))
    .sort((a,b) => b.dias - a.dias || a.nome.localeCompare(b.nome, "pt-BR"));

  const rankingExibido = mostrarRankingCompleto ? ranking : ranking.slice(0, LIMITE_RANKING);
  const tbodyRank = document.getElementById("tabelaRanking");
  tbodyRank.innerHTML = rankingExibido.length
    ? rankingExibido.map((x, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${x.nome}</td>
          <td><strong>${x.dias}</strong></td>
        </tr>
      `).join("")
    : `<tr><td colspan="3" class="muted">Sem registros neste mÃªs.</td></tr>`;

  const btnRank = document.getElementById("btnVerMaisRanking");
  if(ranking.length <= LIMITE_RANKING){
    btnRank.style.display = "none";
  }else{
    btnRank.style.display = "inline-block";
    btnRank.innerText = mostrarRankingCompleto ? "Ver menos" : "Ver mais ranking";
  }

  const registrosOrdenados = [...registrosMes].sort((a,b)=> b.dataISO.localeCompare(a.dataISO));
  const mesExibido = mostrarMesCompleto ? registrosOrdenados : registrosOrdenados.slice(0, LIMITE_MES);

  const tbodyMes = document.getElementById("tabelaMes");
  tbodyMes.innerHTML = mesExibido.length
    ? mesExibido.map(r => `
        <tr>
          <td><strong>${r.dataBR}</strong></td>
          <td>${r.pessoas.join("<br>")}</td>
        </tr>
      `).join("")
    : `<tr><td colspan="2" class="muted">Sem registros neste mÃªs.</td></tr>`;

  const btnMes = document.getElementById("btnVerMaisMes");
  if(registrosOrdenados.length <= LIMITE_MES){
    btnMes.style.display = "none";
  }else{
    btnMes.style.display = "inline-block";
    btnMes.innerText = mostrarMesCompleto ? "Ver menos" : "Ver mais registros do mÃªs";
  }

  /* impressÃ£o: sempre completo */
  document.getElementById("printRanking").innerHTML = ranking.length
    ? ranking.map((x, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${x.nome}</td>
          <td><strong>${x.dias}</strong></td>
        </tr>
      `).join("")
    : `<tr><td colspan="3">Sem registros neste mÃªs.</td></tr>`;

  document.getElementById("printMes").innerHTML = registrosMes.length
    ? registrosMes
        .sort((a,b)=> a.dataISO.localeCompare(b.dataISO))
        .map(r => `
          <tr>
            <td><strong>${r.dataBR}</strong></td>
            <td>${r.pessoas.join(", ")}</td>
          </tr>
        `).join("")
    : `<tr><td colspan="2">Sem registros neste mÃªs.</td></tr>`;

  const mesBR = `${sel.m}/${sel.y}`;
  document.getElementById("reportPeriodo").innerText = `PerÃ­odo: ${mesBR}`;
  document.getElementById("reportGeradoEm").innerText = `Gerado em: ${agoraBR()}`;
}

function toggleVerMaisRanking(){
  mostrarRankingCompleto = !mostrarRankingCompleto;
  atualizarPainel();
}

function toggleVerMaisMes(){
  mostrarMesCompleto = !mostrarMesCompleto;
  atualizarPainel();
}

function gerarPDF(){
  atualizarPainel();
  setTimeout(() => window.print(), 50);
}

/* ===================== INIT ===================== */
(function init(){
  document.getElementById("dataDia").value = hojeISO();

  salvarNomes();
  renderChipsDiario();
  carregarDiario();

  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  document.getElementById("mesAno").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;

  atualizarPainel();
  document.getElementById("mesAno").addEventListener("change", atualizarPainel);
})();
</script>

</body>
</html>

