<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PresenÃ§a diÃ¡ria â€” Contratos</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<!-- ===================== LOGIN ===================== -->
<section class="card container-login" id="loginBox" style="display:none;">
  <div class="card-head">
    <h2>Acesso restrito</h2>
    <p class="muted">Entre com seu e-mail e senha para acessar o controle de presenÃ§a.</p>
  </div>

  <div class="grid-2">
    <div class="field">
      <label>E-mail</label>
      <input id="loginEmail" type="email" placeholder="seuemail@empresa.com" autocomplete="username">
    </div>

    <div class="field">
      <label>Senha</label>
      <input id="loginSenha" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    </div>
  </div>

  <div class="actions">
    <button class="btn" type="button" onclick="login()">Entrar</button>
    <button class="btn secondary" type="button" onclick="esqueciSenha()">Esqueci minha senha</button>
  </div>

  <p class="muted small" id="loginMsg"></p>
</section>

<!-- ===================== APP ===================== -->
<div id="appRoot" style="display:none;">

<header class="topbar no-print">
  <div class="brand">
    <div class="logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div>
      <div class="brand-title">PresenÃ§a diÃ¡ria â€” Contratos</div>
      <div class="brand-subtitle" id="userBadge">Logado como: â€”</div>
    </div>

    <div class="top-actions">
      <div class="field inline">
        <label>Contrato</label>
        <select id="contratoSelect">
          <option value="ferroport">Ferroport</option>
          <option value="porto-sudeste">Porto Sudeste</option>
          <option value="vale">Vale</option>
        </select>
      </div>

      <span class="role-pill" id="rolePill">â€”</span>
      <button class="btn secondary small" type="button" onclick="logout()">Sair</button>
    </div>
  </div>
</header>

<main class="container">

  <!-- ====== RELATÃ“RIO / PAINEL DO GESTOR ====== -->
  <section class="card">
    <div class="card-head">
      <h2>Painel do gestor</h2>
      <p class="muted">Selecione o mÃªs para ver o ranking, resumo e gerar o relatÃ³rio em PDF.</p>
    </div>

    <div class="grid-3">
      <div class="field">
        <label>MÃªs/Ano</label>
        <input id="mesAno" type="month" />
      </div>

      <div class="field">
        <label>Resumo</label>
        <div class="kpi-wrap">
          <div class="kpi">
            <div class="kpi-label">Dias registrados</div>
            <div class="kpi-value" id="kpiDias">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">TÃ©cnicos no mÃªs</div>
            <div class="kpi-value" id="kpiTecnicos">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">PresenÃ§as (total)</div>
            <div class="kpi-value" id="kpiPresencas">0</div>
          </div>
        </div>
      </div>

      <div class="field">
        <label>AÃ§Ãµes</label>
        <div class="actions">
          <button class="btn" type="button" onclick="atualizarPainel()">ğŸ”„ Atualizar</button>
          <button class="btn secondary" type="button" onclick="gerarPDF()">ğŸ“„ Gerar PDF</button>
        </div>
        <p class="muted small">O PDF Ã© gerado via impressÃ£o do navegador (Ctrl+P).</p>
      </div>
    </div>

    <div class="split">
      <div>
        <h3 class="h3">Ranking (dias trabalhados no mÃªs)</h3>
        <table class="table-compact">
          <thead>
            <tr>
              <th>#</th>
              <th>TÃ©cnico</th>
              <th>Dias</th>
              <th style="width:38%;">Progresso</th>
            </tr>
          </thead>
          <tbody id="tabelaRanking"></tbody>
        </table>
      </div>

      <div>
        <h3 class="h3">Registros do mÃªs (para o relatÃ³rio)</h3>
        <table class="table-compact">
          <thead>
            <tr>
              <th>Data</th>
              <th>Pessoas</th>
            </tr>
          </thead>
          <tbody id="tabelaMes"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ====== FORMULÃRIO DIÃRIO ====== -->
  <section class="card" id="cardPresenca">
    <div class="card-head">
      <h2>PresenÃ§a por dia</h2>
      <p class="muted">Selecione a data e marque quem esteve no contrato.</p>
    </div>

    <div class="grid-2">
      <div class="field">
        <label>Data</label>
        <input id="dataDia" type="date" />
      </div>

      <div class="field">
        <label>Pessoas</label>
        <div class="chips" id="chipsDiario"></div>

        <div class="add-nome">
          <input type="text" id="novoNome" placeholder="Adicionar tÃ©cnico (ex: JoÃ£o Silva)">
          <button class="btn" type="button" onclick="adicionarNome()">+ Adicionar</button>
        </div>

        <p class="muted small">Os nomes ficam salvos no banco (tempo real).</p>
        <p class="muted small" id="permMsg" style="display:none;">VocÃª estÃ¡ como TÃ©cnico: algumas aÃ§Ãµes ficam bloqueadas.</p>
      </div>
    </div>

    <div class="actions">
      <button class="btn" type="button" onclick="salvarDiario()">ğŸ’¾ Salvar dia</button>
      <button class="btn secondary" type="button" onclick="limparDiario()">ğŸ§¹ Limpar</button>
      <button class="btn danger" id="btnApagarTudo" type="button" onclick="apagarDiarios()">ğŸ—‘ Apagar tudo</button>
      <button class="btn" type="button" onclick="exportarDiarioCSV()">â¬‡ Exportar Excel</button>
    </div>
  </section>

  <!-- ====== LISTA DE REGISTROS ====== -->
  <section class="card no-print">
    <div class="card-head">
      <h2>PresenÃ§as registradas</h2>
      <p class="muted">Se salvar a mesma data novamente, o sistema atualiza. Use â€œEditarâ€ para carregar um registro.</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Pessoas</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="tabelaDiario"></tbody>
    </table>

    <div class="ver-mais-wrap">
      <button class="btn secondary small" id="btnVerMais" type="button" onclick="toggleVerMais()">
        Ver mais registros
      </button>
    </div>
  </section>

  <footer class="footer no-print">
    DIGITAL â€¢ EMIVE â€¢ Tecnologia e SeguranÃ§a
  </footer>

</main>

</div>

<!-- ====== PDF (impressÃ£o) ====== -->
<section class="print-only report">
  <div class="report-head">
    <div class="report-logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div class="report-titles">
      <div class="report-title">RelatÃ³rio de PresenÃ§a â€” <span id="reportContrato">â€”</span></div>
      <div class="report-subtitle" id="reportPeriodo">PerÃ­odo: â€”</div>
      <div class="report-subtitle" id="reportGeradoEm">Gerado em: â€”</div>
    </div>
  </div>

  <div class="report-grid">
    <div class="report-box">
      <div class="box-title">Ranking â€” Dias trabalhados</div>
      <table class="report-table">
        <thead>
          <tr>
            <th>#</th>
            <th>TÃ©cnico</th>
            <th>Dias</th>
          </tr>
        </thead>
        <tbody id="printRanking"></tbody>
      </table>
    </div>

    <div class="report-box">
      <div class="box-title">Registros do mÃªs</div>
      <table class="report-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Pessoas</th>
          </tr>
        </thead>
        <tbody id="printMes"></tbody>
      </table>
    </div>
  </div>

  <div class="report-footer">
    DIGITAL â€¢ EMIVE â€” Tecnologia e SeguranÃ§a
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // âœ… Sua config (ok expor no front)
  const firebaseConfig = {
    apiKey: "AIzaSyBzgChouE4W25XnD-vFybJrKVN9yl3R0IQ",
    authDomain: "ferroportluannogueira.firebaseapp.com",
    projectId: "ferroportluannogueira",
    storageBucket: "ferroportluannogueira.firebasestorage.app",
    messagingSenderId: "531699539518",
    appId: "1:531699539518:web:6e32a169d9110f70b9fb6f",
    measurementId: "G-61BRVCSHD7"
  };

  // âœ… DEFINA AQUI OS E-MAILS DE GESTOR/ADMIN (podem apagar tudo e apagar registros)
  const ADMIN_EMAILS = [
    // "luan.nogueira@digitaltecnologia.com.br",
    // "outro@empresa.com"
  ];

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Estado
  let LISTA = [];
  let NOMES = [];
  let selecaoDiaria = [];
  let isAdmin = false;

  // Ver mais (lista geral)
  let mostrarTodosRegistros = false;
  const LIMITE_REGISTROS = 5;

  // Contrato atual (multi-contratos)
  const KEY_CONTRATO = "contrato_atual";
  let contratoAtual = localStorage.getItem(KEY_CONTRATO) || "ferroport";

  // Refs (mudam conforme contrato)
  let refDiarios = null;
  let refNomes = null;
  let unsubDiarios = null;
  let unsubNomes = null;

  function setRefsContrato(){
    refDiarios = collection(db, "contratos", contratoAtual, "diarios");
    refNomes   = collection(db, "contratos", contratoAtual, "nomes");
  }

  /* ===================== LOGIN ===================== */
  window.login = async function(){
    const email = document.getElementById("loginEmail").value.trim();
    const senha = document.getElementById("loginSenha").value.trim();
    const msg = document.getElementById("loginMsg");
    msg.textContent = "";

    try{
      await signInWithEmailAndPassword(auth, email, senha);
    }catch(e){
      msg.textContent = "Falha no login: " + (e?.code || e?.message || e);
    }
  };

  window.esqueciSenha = async function(){
    const email = document.getElementById("loginEmail").value.trim();
    const msg = document.getElementById("loginMsg");
    msg.textContent = "";

    if(!email){
      msg.textContent = "Digite seu e-mail para receber o link de redefiniÃ§Ã£o.";
      return;
    }

    try{
      await sendPasswordResetEmail(auth, email);
      msg.textContent = "Pronto! Enviamos um e-mail para redefinir sua senha.";
    }catch(e){
      msg.textContent = "NÃ£o foi possÃ­vel enviar: " + (e?.code || e?.message || e);
    }
  };

  window.logout = async function(){
    await signOut(auth);
  };

  function mostrarApp(logado){
    document.getElementById("loginBox").style.display = logado ? "none" : "block";
    document.getElementById("appRoot").style.display = logado ? "block" : "none";
  }

  function aplicarPermissoesUI(){
    const pill = document.getElementById("rolePill");
    const permMsg = document.getElementById("permMsg");
    const btnApagarTudo = document.getElementById("btnApagarTudo");

    pill.textContent = isAdmin ? "Gestor" : "TÃ©cnico";
    pill.classList.toggle("admin", isAdmin);

    // SÃ³ gestor pode apagar tudo
    btnApagarTudo.style.display = isAdmin ? "inline-block" : "none";
    permMsg.style.display = isAdmin ? "none" : "block";
  }

  /* ===================== UTIL ===================== */
  function formatarDataBR(dataISO){
    const [y,m,d] = dataISO.split("-");
    return `${d}/${m}/${y}`;
  }
  function hojeISO(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function agoraBR(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function getMesAnoSelecionado(){
    const v = document.getElementById("mesAno").value; // YYYY-MM
    if(!v) return null;
    const [y,m] = v.split("-");
    return { y, m };
  }
  function idSeguro(str){
    return str
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g,"-")
      .replace(/[^a-z0-9\-]/g,"")
      .slice(0, 80);
  }
  function nomeContratoBonito(slug){
    const mapa = {
      "ferroport": "Ferroport",
      "porto-sudeste": "Porto Sudeste",
      "vale": "Vale"
    };
    return mapa[slug] || slug;
  }

  /* ===================== REALTIME ===================== */
  function desligarRealtime(){
    if(typeof unsubDiarios === "function") unsubDiarios();
    if(typeof unsubNomes === "function") unsubNomes();
    unsubDiarios = null;
    unsubNomes = null;
  }

  function ligarRealtime(){
    desligarRealtime();

    unsubDiarios = onSnapshot(refDiarios, (snap) => {
      LISTA = snap.docs.map(d => d.data());
      LISTA.sort((a,b)=> a.dataISO.localeCompare(b.dataISO));
      carregarDiario();
      atualizarPainel();
    });

    unsubNomes = onSnapshot(refNomes, (snap) => {
      NOMES = snap.docs.map(d => d.data().nome).sort((a,b)=> a.localeCompare(b, "pt-BR"));
      renderChipsDiario();
    });
  }

  function setContrato(novo){
    contratoAtual = novo;
    localStorage.setItem(KEY_CONTRATO, contratoAtual);
    setRefsContrato();
    ligarRealtime();

    // atualiza tÃ­tulo do PDF
    document.getElementById("reportContrato").textContent = nomeContratoBonito(contratoAtual);

    // limpa seleÃ§Ã£o diÃ¡ria ao trocar contrato
    selecaoDiaria = [];
    renderChipsDiario();
    limparDiario(true);
    atualizarPainel();
  }

  /* ===================== CHIPS ===================== */
  window.renderChipsDiario = function(){
    const wrap = document.getElementById("chipsDiario");
    wrap.innerHTML = "";

    NOMES.forEach(nome => {
      const box = document.createElement("div");
      box.className = "chip-box";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (selecaoDiaria.includes(nome) ? " active" : "");
      btn.innerText = nome;

      btn.onclick = () => {
        if (selecaoDiaria.includes(nome)) {
          selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
        } else {
          selecaoDiaria.push(nome);
        }
        renderChipsDiario();
      };

      const remover = document.createElement("span");
      remover.className = "remove";
      remover.title = "Excluir nome (gestor)";
      remover.innerText = "âœ–";

      // SÃ³ gestor pode excluir nome
      remover.style.display = isAdmin ? "inline-flex" : "none";

      remover.onclick = (e) => {
        e.stopPropagation();
        excluirNome(nome);
      };

      box.appendChild(btn);
      box.appendChild(remover);
      wrap.appendChild(box);
    });
  };

  window.adicionarNome = async function(){
    const input = document.getElementById("novoNome");
    const nome = input.value.trim();

    if(!nome){
      alert("Digite um nome.");
      return;
    }

    const existe = NOMES.some(n => n.toLowerCase() === nome.toLowerCase());
    if(existe){
      alert("Esse nome jÃ¡ existe.");
      return;
    }

    await setDoc(doc(db, "contratos", contratoAtual, "nomes", idSeguro(nome)), { nome });
    input.value = "";
  };

  async function excluirNome(nome){
    if(!isAdmin){
      alert("Somente gestor pode excluir nomes.");
      return;
    }
    if(!confirm(`Deseja excluir "${nome}"?`)) return;
    await deleteDoc(doc(db, "contratos", contratoAtual, "nomes", idSeguro(nome)));
    selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
  }

  /* ===================== CRUD DIÃRIO ===================== */
  window.salvarDiario = async function(){
    const data = document.getElementById("dataDia").value;

    if(!data) return alert("Selecione a data.");
    if(selecaoDiaria.length === 0) return alert("Selecione pelo menos uma pessoa.");

    const item = {
      dataISO: data,
      dataBR: formatarDataBR(data),
      pessoas: [...selecaoDiaria]
    };

    await setDoc(doc(db, "contratos", contratoAtual, "diarios", data), item);
    limparDiario();
  };

  window.editarRegistro = function(dataISO){
    const reg = LISTA.find(x => x.dataISO === dataISO);
    if(!reg) return alert("Registro nÃ£o encontrado.");

    document.getElementById("dataDia").value = reg.dataISO;
    selecaoDiaria = [...(reg.pessoas || [])];
    renderChipsDiario();

    document.getElementById("cardPresenca").scrollIntoView({ behavior: "smooth", block: "start" });
  };

  window.apagarRegistro = async function(dataISO){
    if(!isAdmin){
      alert("Somente gestor pode apagar registros.");
      return;
    }
    if(!confirm("Deseja apagar somente este dia registrado?")) return;
    await deleteDoc(doc(db, "contratos", contratoAtual, "diarios", dataISO));
    if(document.getElementById("dataDia").value === dataISO){
      limparDiario();
    }
  };

  window.limparDiario = function(silencioso=false){
    document.getElementById("dataDia").value = "";
    selecaoDiaria = [];
    renderChipsDiario();
    if(!silencioso) document.getElementById("novoNome").value = "";
  };

  window.apagarDiarios = async function(){
    if(!isAdmin){
      alert("Somente gestor pode apagar tudo.");
      return;
    }
    if(!confirm("Deseja apagar TODOS os registros deste contrato?")) return;

    const snap = await getDocs(refDiarios);
    for(const d of snap.docs){
      await deleteDoc(d.ref);
    }
  };

  window.exportarDiarioCSV = function(){
    if(LISTA.length === 0){
      alert("NÃ£o hÃ¡ registros para exportar.");
      return;
    }

    const ordenado = [...LISTA].sort((a,b) => a.dataISO.localeCompare(b.dataISO));

    let csv = "Contrato;Data;Pessoas\n";
    ordenado.forEach(r => {
      csv += `${nomeContratoBonito(contratoAtual)};${r.dataBR};"${(r.pessoas || []).join(", ")}"\n`;
    });

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `presencas_${contratoAtual}.csv`;
    link.click();
  };

  /* ===================== VER MAIS (LISTA) ===================== */
  function atualizarBotaoVerMais(total){
    const btn = document.getElementById("btnVerMais");
    if(!btn) return;

    if(total <= LIMITE_REGISTROS){
      btn.style.display = "none";
      return;
    }

    btn.style.display = "inline-block";
    btn.innerText = mostrarTodosRegistros ? "Ver menos" : "Ver mais registros";
  }

  window.toggleVerMais = function(){
    mostrarTodosRegistros = !mostrarTodosRegistros;
    carregarDiario();
  };

  /* ===================== TABELA DIÃRIA ===================== */
  function carregarDiario(){
    const tbody = document.getElementById("tabelaDiario");
    if(!tbody) return;
    tbody.innerHTML = "";

    const lista = [...LISTA].sort((a,b) => b.dataISO.localeCompare(a.dataISO));
    const exibida = mostrarTodosRegistros ? lista : lista.slice(0, LIMITE_REGISTROS);

    exibida.forEach(r => {
      tbody.innerHTML += `
        <tr>
          <td><strong>${r.dataBR}</strong></td>
          <td>${(r.pessoas || []).join("<br>")}</td>
          <td>
            <div class="row-actions">
              <button class="btn small secondary" type="button" onclick="editarRegistro('${r.dataISO}')">âœ Editar</button>
              <button class="btn small danger" type="button" onclick="apagarRegistro('${r.dataISO}')" ${isAdmin ? "" : "disabled"}>ğŸ—‘ Apagar</button>
            </div>
          </td>
        </tr>
      `;
    });

    atualizarBotaoVerMais(lista.length);
  }

  /* ===================== PAINEL DO GESTOR ===================== */
  window.atualizarPainel = function(){
    const sel = getMesAnoSelecionado();

    if(!sel){
      const hoje = new Date();
      const pad = (n)=> String(n).padStart(2,"0");
      document.getElementById("mesAno").value = `${hoje.getFullYear()}-${pad(hoje.getMonth()+1)}`;
      return atualizarPainel();
    }

    const prefixo = `${sel.y}-${sel.m}`;
    const registrosMes = LISTA.filter(r => r.dataISO.startsWith(prefixo));

    document.getElementById("kpiDias").innerText = registrosMes.length;

    // total de presenÃ§as (somatÃ³rio de pessoas)
    const totalPresencas = registrosMes.reduce((acc, r) => acc + (r.pessoas ? r.pessoas.length : 0), 0);
    document.getElementById("kpiPresencas").innerText = totalPresencas;

    const contagem = new Map(); // nome -> dias
    registrosMes.forEach(r => {
      const unicos = Array.from(new Set(r.pessoas || []));
      unicos.forEach(p => contagem.set(p, (contagem.get(p) || 0) + 1));
    });

    document.getElementById("kpiTecnicos").innerText = contagem.size;

    const ranking = Array.from(contagem.entries())
      .map(([nome, dias]) => ({ nome, dias }))
      .sort((a,b) => b.dias - a.dias || a.nome.localeCompare(b.nome, "pt-BR"));

    const maxDias = ranking.length ? Math.max(...ranking.map(x => x.dias)) : 0;

    const tbodyRank = document.getElementById("tabelaRanking");
    tbodyRank.innerHTML = ranking.length
      ? ranking.map((x, i) => `
          <tr>
            <td>${i+1}</td>
            <td>${x.nome}</td>
            <td><strong>${x.dias}</strong></td>
            <td>
              <div class="bar">
                <div class="bar-fill" style="width:${maxDias ? (x.dias/maxDias*100).toFixed(0) : 0}%;"></div>
              </div>
            </td>
          </tr>
        `).join("")
      : `<tr><td colspan="4" class="muted">Sem registros neste mÃªs.</td></tr>`;

    const tbodyMes = document.getElementById("tabelaMes");
    tbodyMes.innerHTML = registrosMes.length
      ? [...registrosMes]
          .sort((a,b)=> a.dataISO.localeCompare(b.dataISO))
          .map(r => `
            <tr>
              <td><strong>${r.dataBR}</strong></td>
              <td>${(r.pessoas || []).join("<br>")}</td>
            </tr>
          `).join("")
      : `<tr><td colspan="2" class="muted">Sem registros neste mÃªs.</td></tr>`;

    // impressÃ£o (sempre completo)
    document.getElementById("printRanking").innerHTML = ranking.length
      ? ranking.map((x, i) => `
          <tr>
            <td>${i+1}</td>
            <td>${x.nome}</td>
            <td><strong>${x.dias}</strong></td>
          </tr>
        `).join("")
      : `<tr><td colspan="3">Sem registros neste mÃªs.</td></tr>`;

    document.getElementById("printMes").innerHTML = registrosMes.length
      ? [...registrosMes]
          .sort((a,b)=> a.dataISO.localeCompare(b.dataISO))
          .map(r => `
            <tr>
              <td><strong>${r.dataBR}</strong></td>
              <td>${(r.pessoas || []).join(", ")}</td>
            </tr>
          `).join("")
      : `<tr><td colspan="2">Sem registros neste mÃªs.</td></tr>`;

    const mesBR = `${sel.m}/${sel.y}`;
    document.getElementById("reportPeriodo").innerText = `PerÃ­odo: ${mesBR}`;
    document.getElementById("reportGeradoEm").innerText = `Gerado em: ${agoraBR()}`;
    document.getElementById("reportContrato").textContent = nomeContratoBonito(contratoAtual);
  };

  window.gerarPDF = function(){
    atualizarPainel();
    setTimeout(() => window.print(), 50);
  };

  function initUI(){
    // contrato
    const selContrato = document.getElementById("contratoSelect");
    selContrato.value = contratoAtual;
    selContrato.addEventListener("change", () => setContrato(selContrato.value));

    // data padrÃ£o hoje
    document.getElementById("dataDia").value = hojeISO();

    // mÃªs atual
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    document.getElementById("mesAno").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    document.getElementById("mesAno").addEventListener("change", atualizarPainel);
  }

  onAuthStateChanged(auth, (user) => {
    if(!user){
      mostrarApp(false);
      desligarRealtime();
      return;
    }

    // define role
    const email = (user.email || "").toLowerCase();
    isAdmin = ADMIN_EMAILS.map(x => String(x).toLowerCase()).includes(email);

    // UI
    document.getElementById("userBadge").textContent = `Logado como: ${user.email || "â€”"}`;
    aplicarPermissoesUI();
    mostrarApp(true);

    // refs + realtime
    setRefsContrato();
    ligarRealtime();

    initUI();
    atualizarPainel();
  });
</script>

</body>
</html>

